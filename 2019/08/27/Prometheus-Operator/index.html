<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Prometheus-Operator监控k8s | huisebug</title><meta name="keywords" content="k8s,prometheus,alertmanager,grafana,mysql-export,钉钉告警,企业微信告警"><meta name="author" content="huisebug"><meta name="copyright" content="huisebug"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="这是一篇Prometheus-Operator监控k8s服务的部署、监控原理讲解、监控配置、告警模板配置。">
<meta property="og:type" content="article">
<meta property="og:title" content="Prometheus-Operator监控k8s">
<meta property="og:url" content="https://huisebug.github.io/2019/08/27/Prometheus-Operator/index.html">
<meta property="og:site_name" content="huisebug">
<meta property="og:description" content="这是一篇Prometheus-Operator监控k8s服务的部署、监控原理讲解、监控配置、告警模板配置。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://huisebug.github.io/img/prometheus.jpg">
<meta property="article:published_time" content="2019-08-27T05:53:02.000Z">
<meta property="article:modified_time" content="2021-07-09T02:57:20.670Z">
<meta property="article:author" content="huisebug">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="prometheus">
<meta property="article:tag" content="alertmanager">
<meta property="article:tag" content="grafana">
<meta property="article:tag" content="mysql-export">
<meta property="article:tag" content="钉钉告警">
<meta property="article:tag" content="企业微信告警">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://huisebug.github.io/img/prometheus.jpg"><link rel="shortcut icon" href="/img/linuxqie.jpg"><link rel="canonical" href="https://huisebug.github.io/2019/08/27/Prometheus-Operator/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: huisebug","link":"链接: ","source":"来源: huisebug","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Prometheus-Operator监控k8s',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-07-09 10:57:20'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="huisebug" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/linuxqie.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">23</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">59</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/download/"><i class="fa-fw fas fa-folder-open"></i><span> Download</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/prometheus.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">huisebug</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/download/"><i class="fa-fw fas fa-folder-open"></i><span> Download</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Prometheus-Operator监控k8s</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-08-27T05:53:02.000Z" title="发表于 2019-08-27 13:53:02">2019-08-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-07-09T02:57:20.670Z" title="更新于 2021-07-09 10:57:20">2021-07-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Prometheus/">Prometheus</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Prometheus-Operator监控k8s"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>这是一篇Prometheus-Operator监控k8s服务的部署、监控原理讲解、监控配置、告警模板配置。</p>
<span id="more"></span>



<p>初始条件：</p>
<ul>
<li>  K8s1.12+集群</li>
</ul>
<h1 id="Prometheus-operator"><a href="#Prometheus-operator" class="headerlink" title="Prometheus-operator "></a>Prometheus-operator </h1><h2 id="安装monitoring-coreos-com-v1-api（prometheus-operator）"><a href="#安装monitoring-coreos-com-v1-api（prometheus-operator）" class="headerlink" title="安装monitoring.coreos.com/v1 api（prometheus-operator）"></a>安装monitoring.coreos.com/v1 api（prometheus-operator）</h2><p>此处我们直接使用yaml文件方式安装，不使用helm安装，helm安装会缺少一些服务，不方便我们更深了解</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/coreos/prometheus-operator.git</span><br></pre></td></tr></table></figure>
<p>已迁移到如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/coreos/kube-prometheus.git</span><br><span class="line">cd prometheus-operator/contrib/kube-prometheus</span><br></pre></td></tr></table></figure>
<p><img src="/2019/08/27/Prometheus-Operator/media/a75024b7d92536cdc10f54c8545a1c3b.png"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod --all-namespaces</span><br><span class="line">kubectl api-versions</span><br></pre></td></tr></table></figure>
<p>如果整个集群是否设置tain，解除即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in api.huisebug.com node1.huisebug.com node2.huisebug.com; do kubectl taint nodes $i node-role.kubernetes.io/master:NoSchedule-; done</span><br></pre></td></tr></table></figure>
<h2 id="集群状态"><a href="#集群状态" class="headerlink" title="集群状态"></a>集群状态</h2><p>查看是否建立并启动好所有容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod --all-namespaces -o wide 或者 kubectl get pod -n monitoring</span><br></pre></td></tr></table></figure>
<p><img src="/2019/08/27/Prometheus-Operator/media/7fa22fa29b2998022851543d251dae94.png"></p>
<h2 id="问题汇总"><a href="#问题汇总" class="headerlink" title="问题汇总"></a>问题汇总</h2><ul>
<li>  <strong>Prometheus can’t access node-exporter and kube-state-metrics</strong></li>
</ul>
<p>解决地址</p>
<p><a target="_blank" rel="noopener" href="https://github.com/coreos/prometheus-operator/issues/2330">https://github.com/coreos/prometheus-operator/issues/2330</a></p>
<ul>
<li>  alertmanager无法建立pod，主要是服务器环境硬件跟不上</li>
</ul>
<p>解决地址</p>
<p><a target="_blank" rel="noopener" href="https://github.com/coreos/prometheus-operator/issues/1902">https://github.com/coreos/prometheus-operator/issues/1902</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/coreos/prometheus-operator/issues/965">https://github.com/coreos/prometheus-operator/issues/965</a></p>
<ul>
<li>  prometheus的storage.local.retention（数据存储时间）设置更长时间</li>
</ul>
<p>解决地址</p>
<p><a target="_blank" rel="noopener" href="https://github.com/coreos/prometheus-operator/issues/732">https://github.com/coreos/prometheus-operator/issues/732</a></p>
<p>只需在prometheus-prometheus.yaml文件中增加一行配置</p>
<p><img src="/2019/08/27/Prometheus-Operator/media/2fb7331e54c312463c5817ed4293e280.png"></p>
<p>主要介绍一下alertmanager无法建立pod的问题的解决方法，默认的alertmanager重启嗅探如下：</p>
<p><img src="/2019/08/27/Prometheus-Operator/media/5e37cd97ee9a0ad417dc44df9fbb2f64.png"></p>
<p>即嗅探10*10=100秒以后就会重启，显然模拟环境是无法在100秒内成功启动alertmanager，所以这里我们需要给配置文件alertmanager-alertmanager.yaml添加paused:true参数，添加步骤如下：</p>
<ol>
<li> 首先已经建立所有的prometheus-operator服务（kubectl apply -f manifests/ ）</li>
<li> 然后给alertmanager-alertmanager.yaml添加paused: true参数; paused: true参数解释参考地址：<a target="_blank" rel="noopener" href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#alertmanagerspec">https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#alertmanagerspec</a><br><img src="/2019/08/27/Prometheus-Operator/media/629d37574ccd3a5996ba69138c53299e.png"></li>
<li> 重载配置文件alertmanager-alertmanager.yaml （kubectl apply -f alertmanager-alertmanager.yaml）</li>
<li> 将配置文件alertmanager-alertmanager.yaml建立后生成的statefulset转储到文件中（kubectl get statefulsets alertmanager-main -n monitoring -o yaml &gt; alertmanager-main-statefulsets.yaml）</li>
<li> 在集群中删除alertmanager（kubectl delete -f alertmanager-main-statefulsets.yaml）</li>
<li> 修改文件alertmanager-main-statefulsets.yaml的嗅探失败次数，修改为30次，即30*10=300秒，也可根据你的实际环境来调节<br><img src="/2019/08/27/Prometheus-Operator/media/a5f43f5ed4d781c892b25e579d5eea8f.png"></li>
<li> 再次创建，即可成功建立alertmanager</li>
</ol>
<h1 id="解析prometheus-operator原理"><a href="#解析prometheus-operator原理" class="headerlink" title="解析prometheus-operator原理"></a>解析prometheus-operator原理</h1><p>新加了两个apiversion，获取命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl api-versions</span><br></pre></td></tr></table></figure>
<p>metrics.k8s.io/v1beta1<br>monitoring.coreos.com/v1</p>
<ul>
<li>  <strong>monitoring.coreos.com/v1是作为四个资源对象的组而添加到api中</strong></li>
<li>  <strong>metrics.k8s.io/v1beta1是使用资源对象APIService进行建立的，这个apiversion需关联到service对应的pod prometheus-adapter建立成功才会成功建立，所以记住需要使用kubectl api-versions命令关注是否建立成功</strong></li>
</ul>
<p>使用自定义资源定义CustomResourceDefinitions（CRD）新增4个kind：</p>
<ol>
<li> Prometheus，它定义了所需的Prometheus部署。运营商始终确保正在运行与资源定义匹配的部署。</li>
<li> ServiceMonitor，以声明方式指定应如何监控服务组。操作员根据定义自动生成Prometheus刮削配置。</li>
<li> PrometheusRule，它定义了一个所需的Prometheus规则文件，该文件可以由包含Prometheus警报和记录规则的Prometheus实例加载。</li>
<li> Alertmanager，它定义了所需的Alertmanager部署。运营商始终确保正在运行与资源定义匹配的部署。</li>
</ol>
<p><strong>获取命令如下</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get Servicemonitor --all-namespaces</span><br><span class="line">kubectl get Prometheus --all-namespaces</span><br></pre></td></tr></table></figure>

<h2 id="yaml类型"><a href="#yaml类型" class="headerlink" title="yaml类型"></a>yaml类型</h2><ol>
<li> 0prometheus-operator*：建立整个prometheus-operator的CRD、提供服务支持的pod运行</li>
<li> alertmanager*：prometheus所需的告警处理，alertmanager告警的pod建立</li>
<li> grafana*：监控页面展示</li>
<li> kube-state-metrics*：增加对deployment建立的pod、statefulset建立的pod等资源对象的metrics数据，参考地址：<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kube-state-metrics">https://github.com/kubernetes/kube-state-metrics</a></li>
<li> node-exporter*：运行k8s集群的node的服务器数据抓取</li>
<li> prometheus-adapter：为<strong>metrics.k8s.io/v1beta1</strong>提供metrics数据支持，获取集群的node和pod的CPU、内存使用情况，但是在这里只能获取到pod的，无法获取node的，后续将会在<strong>HPA V2</strong>章节讲解如何解决。</li>
<li> prometheus*：prometheus监控系统的pod建立，为需要添加到监控列表的服务增加metrics</li>
</ol>
<h2 id="简易原理"><a href="#简易原理" class="headerlink" title="简易原理"></a>简易原理</h2><p>数据源是从prometheus获取的，那么prometheus是如何获取k8s中这些数据的呢？</p>
<ol>
<li> 资源类型ServiceMonitor来定义添加的要被监控的k8s的服务service，然后使用operator工具来定义一个资源类型Prometheus进行筛选ServiceMonitor进行服务监控。PrometheusRule和Alertmanager进行规制和告警设置。</li>
</ol>
<h2 id="资源类型Prometheus"><a href="#资源类型Prometheus" class="headerlink" title="资源类型Prometheus"></a>资源类型Prometheus</h2><p>这里我们来深度解析下这个资源类型为Prometheus</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get Prometheus --all-namespaces -o yaml &gt; k8s-prometheus.yaml</span><br></pre></td></tr></table></figure>
<p>去除一些不必要的信息后，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">items:</span><br><span class="line">- apiVersion: monitoring.coreos.com/v1</span><br><span class="line">  kind: Prometheus</span><br><span class="line">  metadata:</span><br><span class="line">    labels:</span><br><span class="line">      prometheus: k8s</span><br><span class="line">    name: k8s</span><br><span class="line">    namespace: monitoring</span><br><span class="line">  spec:</span><br><span class="line">    alerting:</span><br><span class="line">      alertmanagers:</span><br><span class="line">      - name: alertmanager-main</span><br><span class="line">        namespace: monitoring</span><br><span class="line">        port: web</span><br><span class="line">    baseImage: quay.io/prometheus/prometheus</span><br><span class="line">    nodeSelector:</span><br><span class="line">      beta.kubernetes.io/os: linux</span><br><span class="line">    replicas: 2</span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        memory: 400Mi</span><br><span class="line">    ruleSelector:</span><br><span class="line">      matchLabels:</span><br><span class="line">        prometheus: k8s</span><br><span class="line">        role: alert-rules</span><br><span class="line">    securityContext:</span><br><span class="line">      fsGroup: 2000</span><br><span class="line">      runAsNonRoot: true</span><br><span class="line">      runAsUser: 1000</span><br><span class="line">    serviceAccountName: prometheus-k8s</span><br><span class="line">    serviceMonitorNamespaceSelector: &#123;&#125;</span><br><span class="line">    serviceMonitorSelector: &#123;&#125;</span><br><span class="line">    version: v2.5.0</span><br><span class="line">kind: List</span><br><span class="line">metadata:</span><br><span class="line">  resourceVersion: &quot;&quot;</span><br><span class="line">  selfLink: &quot;&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">kind: List</span><br><span class="line">metadata:</span><br><span class="line">  resourceVersion: &quot;&quot;</span><br><span class="line">  selfLink: &quot;&quot;</span><br><span class="line">这一段是定义多个，不必在意。</span><br><span class="line"></span><br><span class="line">- apiVersion: monitoring.coreos.com/v1</span><br><span class="line">  kind: Prometheus</span><br><span class="line">  metadata:</span><br><span class="line">    labels:</span><br><span class="line">      prometheus: k8s</span><br><span class="line">    name: k8s</span><br><span class="line">    namespace: monitoring</span><br><span class="line">这是基础的头定义，定义了api类型，资源对象类型，标签，名称，命名空间。</span><br><span class="line"></span><br><span class="line">alerting:</span><br><span class="line">      alertmanagers:</span><br><span class="line">      - name: alertmanager-main</span><br><span class="line">        namespace: monitoring</span><br><span class="line">        port: web</span><br><span class="line">这是定义告警方式的alertmanager的k8s服务service名称（kubectl get svc –all-namespaces）获取查看，web是定义service时spec.ports下的一个名称name（kubectl get svc alertmanager-main -n monitoring -o yaml）获取查看。</span><br><span class="line"></span><br><span class="line">baseImage: quay.io/prometheus/prometheus</span><br><span class="line">    nodeSelector:</span><br><span class="line">      beta.kubernetes.io/os: linux</span><br><span class="line">    replicas: 2</span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        memory: 400Mi</span><br><span class="line">设置prometheus建立pod时的参数，基础镜像，节点选择，副本因子数，资源配额。</span><br><span class="line"></span><br><span class="line">ruleSelector:</span><br><span class="line">      matchLabels:</span><br><span class="line">        prometheus: k8s</span><br><span class="line">        role: alert-rules</span><br><span class="line">规则选择器，依照标签来选择规则列表，获取规则列表可以（kubectl get prometheusrule prometheus-k8s-rules -n monitoring），prometheus-operator添加api时候定义了一个新的资源类型PrometheusRule，如何查看添加哪些新的kind呢，我是依照安装prometheus-operator时候会建立资源对象推断出的</span><br><span class="line"></span><br><span class="line">    securityContext:</span><br><span class="line">      fsGroup: 2000</span><br><span class="line">      runAsNonRoot: true</span><br><span class="line">      runAsUser: 1000</span><br><span class="line">安全上下文配置，这里我猜测应该是基于容器container的安全上下文配置。具体参考官方</span><br><span class="line">https://www.kubernetes.org.cn/security-context-psp</span><br><span class="line"></span><br><span class="line">serviceAccountName: prometheus-k8s</span><br><span class="line">RBAC认证账户</span><br><span class="line"></span><br><span class="line">serviceMonitorNamespaceSelector: &#123;&#125;</span><br><span class="line">服务监控（ServiceMonitor）命名空间选择，这里是匹配所有；</span><br><span class="line"></span><br><span class="line">serviceMonitorSelector: &#123;&#125;</span><br><span class="line">对（ServiceMonitor）进行筛选，这里也是匹配所有</span><br><span class="line"></span><br><span class="line">version: v2.5.0</span><br><span class="line">镜像的版本号，即prometheus的版本号</span><br><span class="line"></span><br><span class="line">建立的pod是使用statefulsets部署的</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="资源类型PrometheusRule"><a href="#资源类型PrometheusRule" class="headerlink" title="资源类型PrometheusRule"></a>资源类型PrometheusRule</h2><p>专门用于prometheus的rules配置,执行以下命令来参照修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get prometheusrule prometheus-k8s-rules -n monitoring -o yaml</span><br></pre></td></tr></table></figure>
<p>后续将会在企业微信告警配置中讲解</p>
<h2 id="资源类型ServiceMonitor"><a href="#资源类型ServiceMonitor" class="headerlink" title="资源类型ServiceMonitor"></a>资源类型ServiceMonitor</h2><p>kubectl get Servicemonitor –all-namespaces<br>以下举例三个不同namespace下的service进行说明</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">kubectl get Servicemonitor kube-apiserver -n monitoring -o yaml &gt; kube-apiserver-servicemonitor.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: monitoring.coreos.com/v1</span><br><span class="line">kind: ServiceMonitor</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: apiserver</span><br><span class="line">  name: kube-apiserver</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  endpoints:</span><br><span class="line">  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">    interval: 30s</span><br><span class="line">    metricRelabelings:</span><br><span class="line">    - action: drop</span><br><span class="line">      regex: etcd_(debugging|disk|request|server).*</span><br><span class="line">      sourceLabels:</span><br><span class="line">      - __name__</span><br><span class="line">    port: https</span><br><span class="line">    scheme: https</span><br><span class="line">    tlsConfig:</span><br><span class="line">      caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      serverName: kubernetes</span><br><span class="line">  jobLabel: component</span><br><span class="line">  namespaceSelector:</span><br><span class="line">    matchNames:</span><br><span class="line">    - default</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      component: apiserver</span><br><span class="line">      provider: kubernetes</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">kubectl get Servicemonitor node-exporter -n monitoring -o yaml &gt; node-exporter-servicemonitor.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: monitoring.coreos.com/v1</span><br><span class="line">kind: ServiceMonitor</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: node-exporter</span><br><span class="line">  name: node-exporter</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  endpoints:</span><br><span class="line">  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">    interval: 30s</span><br><span class="line">    port: https</span><br><span class="line">    scheme: https</span><br><span class="line">    tlsConfig:</span><br><span class="line">      insecureSkipVerify: true</span><br><span class="line">  jobLabel: k8s-app</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: node-exporter	</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">kubectl get Servicemonitor coredns -n monitoring -o yaml &gt; coredns-servicemonitor.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: monitoring.coreos.com/v1</span><br><span class="line">kind: ServiceMonitor</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  endpoints:</span><br><span class="line">  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">    interval: 15s</span><br><span class="line">    port: metrics</span><br><span class="line">  namespaceSelector:</span><br><span class="line">    matchNames:</span><br><span class="line">    - kube-system</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kube-dns</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">endpoints:   #端点配置</span><br><span class="line">  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token  #serviceaccount自动建立的token</span><br><span class="line">    interval: 30s       #间隔时间</span><br><span class="line">    metricRelabelings:    </span><br><span class="line">    - action: drop</span><br><span class="line">      regex: etcd_(debugging|disk|request|server).*</span><br><span class="line">      sourceLabels:</span><br><span class="line">      - __name__</span><br><span class="line">    port: https        #端点配置中的port定义名称，使用kubectl get ep ep名称 -o yaml 可以查看到 </span><br><span class="line">scheme: https       #访问metrics的方式，一般是http和https，但是源代码是没有固定参数，可以任意传字符串，所以这里还是写http或者https</span><br><span class="line">tlsConfig: #在抓取端点时使用的TLS配置</span><br><span class="line"></span><br><span class="line">namespaceSelector:        #命名空间选择器</span><br><span class="line">    matchNames:     #当监控的pod与servicemonitor不在同一个命名空间就需要进行筛选，使用any： true匹配所有命名空间，不然就写matchNames来匹配</span><br><span class="line">    - default</span><br><span class="line"></span><br><span class="line">selector:        #service标签选择器，kubectl get svc kubernetes -o yaml进行查看，注意svc必须在metadata.label下声明才能进行匹配。</span><br><span class="line">    matchLabels:</span><br><span class="line">      component: apiserver</span><br><span class="line">      provider: kubernetes</span><br></pre></td></tr></table></figure>

<p>官方解析地址如下：<br><a target="_blank" rel="noopener" href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md">https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md</a></p>
<h2 id="资源对象Alertmanagers"><a href="#资源对象Alertmanagers" class="headerlink" title="资源对象Alertmanagers"></a>资源对象Alertmanagers</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">kubectl get alertmanagers main -n monitoring -o yaml &gt; main-alertmanagers.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">items:</span><br><span class="line">- apiVersion: monitoring.coreos.com/v1</span><br><span class="line">  kind: Alertmanager</span><br><span class="line">  metadata:</span><br><span class="line">    labels:</span><br><span class="line">      alertmanager: main</span><br><span class="line">    name: main</span><br><span class="line">    namespace: monitoring</span><br><span class="line">  spec:</span><br><span class="line">    baseImage: quay.io/prometheus/alertmanager</span><br><span class="line">    nodeSelector:</span><br><span class="line">      beta.kubernetes.io/os: linux</span><br><span class="line">    replicas: 3</span><br><span class="line">    securityContext:</span><br><span class="line">      fsGroup: 2000</span><br><span class="line">      runAsNonRoot: true</span><br><span class="line">      runAsUser: 1000</span><br><span class="line">    serviceAccountName: alertmanager-main</span><br><span class="line">    version: v0.15.3</span><br><span class="line">kind: List</span><br><span class="line">metadata:</span><br><span class="line">  resourceVersion: &quot;&quot;</span><br><span class="line">  selfLink: &quot;&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- apiVersion: monitoring.coreos.com/v1</span><br><span class="line">  kind: Alertmanager</span><br><span class="line">  metadata:</span><br><span class="line">    labels:</span><br><span class="line">      alertmanager: main</span><br><span class="line">    name: main</span><br><span class="line">    namespace: monitoring</span><br><span class="line">这是基础的头定义，定义了api类型，资源对象类型，标签，名称，命名空间。</span><br><span class="line">spec:</span><br><span class="line">baseImage: quay.io/prometheus/alertmanager</span><br><span class="line">    nodeSelector:</span><br><span class="line">      beta.kubernetes.io/os: linux</span><br><span class="line">    replicas: 3</span><br><span class="line">    securityContext:</span><br><span class="line">      fsGroup: 2000</span><br><span class="line">      runAsNonRoot: true</span><br><span class="line">      runAsUser: 1000</span><br><span class="line">        </span><br><span class="line">设置prometheus建立pod时的参数，基础镜像，节点选择，副本因子数，安全上下文。</span><br><span class="line">安全上下文配置，这里我猜测应该是基于容器container的安全上下文配置。具体参考官方https://www.kubernetes.org.cn/security-context-psp</span><br><span class="line"></span><br><span class="line">serviceAccountName: alertmanager-main</span><br><span class="line">RBAC认证账户</span><br><span class="line"></span><br><span class="line">version: v0.15.3</span><br><span class="line">镜像的版本号，即alertmanager的版本号</span><br><span class="line"></span><br><span class="line">建立的pod是使用statefulsets部署的，会建立一个无头服务service：</span><br><span class="line">serviceName: alertmanager-operated</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>使用命令kubectl get statefulsets alertmanager-main -n monitoring -o yaml可以查看到；</strong><br><img src="/2019/08/27/Prometheus-Operator/media/d169d095774698249244fe235ae40837.png"></p>
<h1 id="验证效果"><a href="#验证效果" class="headerlink" title="验证效果"></a>验证效果</h1><p>查看建立的service，我们需要访问prometheus数据源和grafana的监控展示web-UI界面，如何访问呢，可以使用service的Nodeport方式，显然这是非常lose的，这里我使用traefik代理方式（traefik安装就不赘述了），建立ingress</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">第一步，查看service</span><br><span class="line">kubectl get svc --all-namespaces</span><br><span class="line"></span><br><span class="line">第二步，查看ingress</span><br><span class="line">kubectl get ingress --all-namespaces</span><br><span class="line"></span><br><span class="line">新建一个ingress在命名空间monitoring下的</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-k8s-grafana</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">    - host: prometheus.huisebug.com</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">          - backend:</span><br><span class="line">              serviceName: prometheus-k8s</span><br><span class="line">              servicePort: 9090</span><br><span class="line">            path: /</span><br><span class="line">    - host: grafana.huisebug.com</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">          - backend:</span><br><span class="line">              serviceName: grafana</span><br><span class="line">              servicePort: 3000</span><br><span class="line">            path: /</span><br></pre></td></tr></table></figure>
<p>给客户机的hosts添加本地解析记录<br>192.168.137.13 prometheus.huisebug.com grafana.huisebug.com</p>
<h2 id="grafana-huisebug-com"><a href="#grafana-huisebug-com" class="headerlink" title="grafana.huisebug.com"></a>grafana.huisebug.com</h2><p>grafana.huisebug.com需要密码验证用户名admin 密码admin并提示修改初始密码</p>
<p>grafana已经添加了k8s集群的监控</p>
<p><img src="/2019/08/27/Prometheus-Operator/media/c94d7f6a843e9df190914a2abca78c2e.png"></p>
<h2 id="prometheus-huisebug-com"><a href="#prometheus-huisebug-com" class="headerlink" title="prometheus.huisebug.com"></a>prometheus.huisebug.com</h2><p><img src="/2019/08/27/Prometheus-Operator/media/650ae2d1f247399562f4fb6ce90f9515.png"></p>
<p>从上面可以看到没有获取到kube-controller-manager、kube-scheduler的metric，接下来就解决这个问题，因为这2个服务不是使用kubeadm方式部署的是使用二进制部署的，所以无法获取到。使用kubeadm方式部署的服务都是存在于namespace:kube-system中，例如：</p>
<p><img src="/2019/08/27/Prometheus-Operator/media/d37b4268d6fb43051831ca9581da35bd.png"></p>
<h1 id="metrics"><a href="#metrics" class="headerlink" title="metrics"></a>metrics</h1><h2 id="解决scheduler和controller-manager的metric"><a href="#解决scheduler和controller-manager的metric" class="headerlink" title="解决scheduler和controller-manager的metric"></a>解决scheduler和controller-manager的metric</h2><p>想要解决上述问题，先来查看整个集群的service和endpoint<br><img src="/2019/08/27/Prometheus-Operator/media/9e6546ab25a4f4d1cce61a3413baa3db.png"><br>可以看到：</p>
<ul>
<li>  service中不存在kube-controller-manager、kube-scheduler</li>
<li>  endpoint中都有</li>
</ul>
<p>所以我们需要建立对应的service和修改endpoint的参数</p>
<p>注意新建立service的port名称要与serviceMonitor配置文件对应的上<br><img src="/2019/08/27/Prometheus-Operator/media/b3309bb846a64600ecc3293dfeaba2ab.png"></p>
<p>参考地址,记得修改其中的地址为你的服务器node_ip地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/huisebug/k8s1.12-Ecosphere/master/Prometheus-operator/metrics/scheduler_controller-manager/metics_services.yaml</span><br></pre></td></tr></table></figure>

<p>如果建立后还是无法访问记得使用命令netstat -lntp查看端口是否设置是所有网卡可以访问，如果是127.0.0.1，就修改服务的启动参数，设置为0.0.0.0</p>
<p>上述修改完毕后，就可以再次查看是否成功获取到<br><img src="/2019/08/27/Prometheus-Operator/media/d79e172a8e29f7deddbe41ea5223e99f.png"></p>
<h2 id="mysql-metrics"><a href="#mysql-metrics" class="headerlink" title="mysql-metrics"></a>mysql-metrics</h2><p>此处我们建立一个mysql服务的metric验证</p>
<h3 id="首先建立一个mysql服务"><a href="#首先建立一个mysql服务" class="headerlink" title="首先建立一个mysql服务"></a>首先建立一个mysql服务</h3><p>参考地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/huisebug/k8s1.12-Ecosphere/master/Prometheus-operator/metrics/mysql-metrics/mysql-metric.yaml</span><br></pre></td></tr></table></figure>
<p>测试是否成功建立mysql服务命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -it mysql sh -c &#x27;exec mysql -h192.168.137.13 -P32306 -pmysql -uroot&#x27;</span><br></pre></td></tr></table></figure>
<p>如果能登录，说明mysql服务已经建立<br><img src="/2019/08/27/Prometheus-Operator/media/79bbd7c67dd266a4e97e04147ac8aa07.png"></p>
<h3 id="使用helm方式安装mysql-exporter"><a href="#使用helm方式安装mysql-exporter" class="headerlink" title="使用helm方式安装mysql-exporter"></a>使用helm方式安装mysql-exporter</h3><p>找到到之前安装traefik的官方charts目录；<br>进入到stable/prometheus-mysql-exporter目录下就是mysql-exporter的chart了；<br>values.yaml文件中要指定mysql服务的用户和密码。然后再安装<br><img src="/2019/08/27/Prometheus-Operator/media/ffd56c5b5235fb6b8e27c715f6d36dd5.png"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install -f values.yaml --name mysql-exporter .</span><br></pre></td></tr></table></figure>
<p><img src="/2019/08/27/Prometheus-Operator/media/99ce34a2797daee5e18254382881bf5d.png"></p>
<h3 id="访问mysql-exporter是否有metric生成"><a href="#访问mysql-exporter是否有metric生成" class="headerlink" title="访问mysql-exporter是否有metric生成"></a>访问mysql-exporter是否有metric生成</h3><p>这里同样采用traefik代理来访问，建立ingress，上述两个pod都是建立在default命名空间的。</p>
<p>ingress yaml文件参考地址：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/huisebug/k8s1.12-Ecosphere/blob/master/Prometheus-operator/metrics/mysql-metrics/mysql-metric.yaml</span><br></pre></td></tr></table></figure>
<p>本地解析添加<br>192.168.137.13 mysqlexporter.huisebug.com</p>
<p>验证访问<a target="_blank" rel="noopener" href="http://mysqlexporter.huisebug.com/metrics">http://mysqlexporter.huisebug.com/metrics</a><br><img src="/2019/08/27/Prometheus-Operator/media/1e0514c33f9c540cdfc6880f42a3d971.png"></p>
<h3 id="ServiceMonitor资源对象建立"><a href="#ServiceMonitor资源对象建立" class="headerlink" title="ServiceMonitor资源对象建立"></a>ServiceMonitor资源对象建立</h3><p>查看service的对应标签，用于servicemonitor</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc mysql-exporter-prometheus-mysql-exporter -o yaml| grep -1 labels</span><br></pre></td></tr></table></figure>
<p><img src="/2019/08/27/Prometheus-Operator/media/20f49c74e35290151302f7657fac6d16.png"></p>
<p>参考yaml地址<br><a target="_blank" rel="noopener" href="https://github.com/huisebug/k8s1.12-Ecosphere/blob/master/Prometheus-operator/metrics/mysql-metrics/mysql-metric.yaml">https://github.com/huisebug/k8s1.12-Ecosphere/blob/master/Prometheus-operator/metrics/mysql-metrics/mysql-metric.yaml</a></p>
<p><font color="red" size="6">记住servicemonitor必须建立在monitor命名空间下</font></p>
<h3 id="Prometheus资源对象建立"><a href="#Prometheus资源对象建立" class="headerlink" title="Prometheus资源对象建立"></a>Prometheus资源对象建立</h3><p>promethes资源对象在安装<strong>monitoring.coreos.com/v1</strong> api的时候建立了一个匹配所有servicemonitot的prometheus资源对象，所以这里我就不建立了，可以参考以下地址：<br><a target="_blank" rel="noopener" href="https://github.com/coreos/prometheus-operator/blob/master/contrib/kube-prometheus/manifests/prometheus-prometheus.yaml">https://github.com/coreos/prometheus-operator/blob/master/contrib/kube-prometheus/manifests/prometheus-prometheus.yaml</a></p>
<h3 id="验证效果-1"><a href="#验证效果-1" class="headerlink" title="验证效果"></a>验证效果</h3><p>再次访问prometheus的target页面查看是否成功获取</p>
<p><img src="/2019/08/27/Prometheus-Operator/media/0ce7ae823851da215e533b770df42b93.png"></p>
<p>成功建立mysql-metric</p>
<h2 id="traefik-metrics"><a href="#traefik-metrics" class="headerlink" title="traefik-metrics"></a>traefik-metrics</h2><h3 id="metrics建立"><a href="#metrics建立" class="headerlink" title="metrics建立"></a>metrics建立</h3><p>之前建立traefik的时候开启dashboard.enabled=true,dashboard.domain=traefik.huisebug.com,metrics.prometheus.enabled=true<br>这样我们就可以访问到traefik的metrics</p>
<p>访问地址：<a target="_blank" rel="noopener" href="http://traefik.huisebug.com/metrics">http://traefik.huisebug.com/metrics</a></p>
<p><img src="/2019/08/27/Prometheus-Operator/media/45a04fd447062832133a6db5fa9f7135.png"></p>
<h3 id="ServiceMonitor资源对象建立-1"><a href="#ServiceMonitor资源对象建立-1" class="headerlink" title="ServiceMonitor资源对象建立"></a>ServiceMonitor资源对象建立</h3><p>参考yaml文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/huisebug/k8s1.12-Ecosphere/master/Prometheus-operator/metrics/traefik-metrics/traefik-metrics.yaml</span><br></pre></td></tr></table></figure>

<h3 id="验证效果-2"><a href="#验证效果-2" class="headerlink" title="验证效果"></a>验证效果</h3><p><img src="/2019/08/27/Prometheus-Operator/media/6412727c854d8dec8afa4048d4372318.png"></p>
<h1 id="alertmanager告警"><a href="#alertmanager告警" class="headerlink" title="alertmanager告警"></a>alertmanager告警</h1><p>alertmanager也是提供了web访问控制台的，先使用ingress进行访问</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/huisebug/k8s1.12-Ecosphere/master/Prometheus-operator/alertmanager/alertmanager-ingress.yaml</span><br></pre></td></tr></table></figure>

<p>记得本地添加解析记录</p>
<p>访问效果</p>
<p><img src="/2019/08/27/Prometheus-Operator/media/83a70cb03cfb322a21960c1fe68311b4.png"></p>
<p>可以看到告警信息这么多，无法找到接收者，所以堆积了。</p>
<p>查看alertmanager的配置参数</p>
<p><img src="/2019/08/27/Prometheus-Operator/media/e4b8bd6bf0c5a44e1066f84b7e374a75.png"></p>
<p>下面演示如何用钉钉群组来接收告警信息</p>
<h2 id="钉钉webhook报警2-0版本8060"><a href="#钉钉webhook报警2-0版本8060" class="headerlink" title="钉钉webhook报警2.0版本8060"></a>钉钉webhook报警2.0版本8060</h2><h3 id="安装钉钉插件"><a href="#安装钉钉插件" class="headerlink" title="安装钉钉插件"></a>安装钉钉插件</h3><h4 id="物理机安装"><a href="#物理机安装" class="headerlink" title="物理机安装"></a>物理机安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/timonwong/prometheus-webhook-dingtalk/releases/download/v0.3.0/prometheus-webhook-dingtalk-0.3.0.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">tar解压后启动</span><br><span class="line"></span><br><span class="line">nohup ./prometheus-webhook-dingtalk --ding.profile=&quot;ops_dingding=钉钉机器人处复制webhook&quot; 2&gt;&amp;1 1&gt;dingding.log &amp;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>物理方式安装就不过多介绍</p>
<h4 id="Docker单机容器部署"><a href="#Docker单机容器部署" class="headerlink" title="Docker单机容器部署"></a>Docker单机容器部署</h4><h5 id="钉钉webhook-容器建立"><a href="#钉钉webhook-容器建立" class="headerlink" title="钉钉webhook 容器建立"></a>钉钉webhook 容器建立</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --restart=always -p 8060:8060 --name=prometheus-webhook-dingtalk timonwong/prometheus-webhook-dingtalk --ding.profile=&quot;ops_dingding=钉钉机器人处复制webhook&quot;</span><br></pre></td></tr></table></figure>
<h5 id="修改alertmanager-yaml内容"><a href="#修改alertmanager-yaml内容" class="headerlink" title="修改alertmanager.yaml内容"></a>修改alertmanager.yaml内容</h5><p>此处需要修改/root/prometheus-operator-history/contrib/kube-prometheus/manifests/alertmanager-secret.yaml文件，其中的data数据是经过base64加密的，复制出来随便去一个base64解码即可看到。或者运行下面的命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat alertmanager-secret.yaml | grep alertmanager.yaml | cut -f 2- -d &quot;:&quot; | tr -d &quot; &quot; | base64 –d</span><br></pre></td></tr></table></figure>
<p><img src="/2019/08/27/Prometheus-Operator/media/ce16fd528480ca5dc6accbe565813805.png"></p>
<p>我们需要将secret中的alertmanager.yaml修改为如下的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  resolve_timeout: 1h</span><br><span class="line">route:</span><br><span class="line">  receiver: webhook</span><br><span class="line">  group_wait: 30s</span><br><span class="line">  group_interval: 30s</span><br><span class="line">  repeat_interval: 10m</span><br><span class="line">  group_by: [alertname]</span><br><span class="line">  routes:</span><br><span class="line">  - receiver: webhook</span><br><span class="line">    group_wait: 30s</span><br><span class="line">    match:</span><br><span class="line">      team: node</span><br><span class="line">receivers:</span><br><span class="line">- name: webhook</span><br><span class="line">  webhook_configs:</span><br><span class="line">  - url: http://192.168.137.13:8060/dingtalk/ops_dingding/send</span><br><span class="line">    send_resolved: true</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>上述的地址记得修改为你的服务器IP地址</p>
<p>首先在同一级目录下建立一个alertmanager.yaml文件，内容就是如上</p>
<p>运行如下命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALT_S=$(cat alertmanager-secret.yaml | grep alertmanager.yaml | cut -f 2- -d &quot;:&quot; | tr -d &quot; &quot;)</span><br><span class="line">ALT_D=$(cat alertmanager.yaml | base64 | tr -d &quot;n&quot; )</span><br><span class="line">sed -i &quot;s/$ALT_S/$ALT_D/&quot; ./alertmanager-secret.yaml</span><br></pre></td></tr></table></figure>
<p>即可完成替换，然后重新建立secret，从之前的alertmanager-main-statefulsets.yaml文件中可以看出secret是挂载到卷的，不是环境变量的方式，这样是支持热更新的</p>
<p><img src="/2019/08/27/Prometheus-Operator/media/669cdd83d0ce476a8c71ed066323249f.png"></p>
<h1 id="执行修改后的secret文件"><a href="#执行修改后的secret文件" class="headerlink" title="执行修改后的secret文件"></a>执行修改后的secret文件</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f alertmanager-secret.yaml</span><br></pre></td></tr></table></figure>
<p>查看是否修改成功</p>
<p><img src="/2019/08/27/Prometheus-Operator/media/7ee31846b6d89f96cc4906984556d0e6.png"></p>
<h4 id="集群方式部署"><a href="#集群方式部署" class="headerlink" title="集群方式部署"></a>集群方式部署</h4><p>都失败了，暂时放弃这种想法了。</p>
<h5 id="hostnetwork方式访问"><a href="#hostnetwork方式访问" class="headerlink" title="hostnetwork方式访问"></a>hostnetwork方式访问</h5><p>参考yaml地址<br><a target="_blank" rel="noopener" href="https://github.com/huisebug/k8s1.12-Ecosphere/tree/master/Prometheus-operator/alertmanager/hostnetwork%E6%96%B9%E5%BC%8F">https://github.com/huisebug/k8s1.12-Ecosphere/tree/master/Prometheus-operator/alertmanager/hostnetwork%E6%96%B9%E5%BC%8F</a></p>
<h5 id="service方式访问"><a href="#service方式访问" class="headerlink" title="service方式访问"></a>service方式访问</h5><p>这种方式会存在问题</p>
<p>alertmanager的日志</p>
<p><img src="/2019/08/27/Prometheus-Operator/media/7bd2e8ce4126f01a2e22c66c7409552c.png"></p>
<p>钉钉插件日志</p>
<p><img src="/2019/08/27/Prometheus-Operator/media/e4c36138aa9877ebd76c385982790997.png"></p>
<p>参考yaml文件</p>
<p><a target="_blank" rel="noopener" href="https://github.com/huisebug/k8s1.12-Ecosphere/blob/master/Prometheus-operator/alertmanager/dd_webhook-deployment-svc.yaml">https://github.com/huisebug/k8s1.12-Ecosphere/blob/master/Prometheus-operator/alertmanager/dd_webhook-deployment-svc.yaml</a></p>
<p>需要将其中的webhook设置成你的</p>
<h6 id="修改alertmanager-yaml内容-1"><a href="#修改alertmanager-yaml内容-1" class="headerlink" title="修改alertmanager.yaml内容"></a>修改alertmanager.yaml内容</h6><p>此处需要修改/root/prometheus-operator-history/contrib/kube-prometheus/manifests/alertmanager-secret.yaml文件，其中的data数据是经过base64加密的，为了不与上面混淆，将其复制并命名为alertmanager-secret-k8sdd.yaml</p>
<p>我们需要将secret中的alertmanager.yaml修改为如下的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  resolve_timeout: 1h</span><br><span class="line">route:</span><br><span class="line">  receiver: webhook</span><br><span class="line">  group_wait: 30s</span><br><span class="line">  group_interval: 30s</span><br><span class="line">  repeat_interval: 10m</span><br><span class="line">  group_by: [alertname]</span><br><span class="line">  routes:</span><br><span class="line">  - receiver: webhook</span><br><span class="line">    group_wait: 30s</span><br><span class="line">    match:</span><br><span class="line">      team: node</span><br><span class="line">receivers:</span><br><span class="line">- name: webhook</span><br><span class="line">  webhook_configs:</span><br><span class="line">  - url: http://dd-webhook:8060/dingtalk/ops_dingding/send</span><br><span class="line">    send_resolved: true</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>首先在同一级目录下建立一个alertmanager-k8sdd.yaml文件，内容就是如上，修改了地址为service名称<br>运行如下命令，记住alertmanager-k8sdd.yaml不能存在注释符号</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALT_S=$(cat alertmanager-secret-k8sdd.yaml | grep alertmanager.yaml | cut -f 2- -d &quot;:&quot; | tr -d &quot; &quot;)</span><br><span class="line">ALT_D=$(cat alertmanager-k8sdd.yaml | base64 | tr -d &quot;n&quot; )</span><br><span class="line">sed -i &quot;s/$ALT_S/$ALT_D/&quot; ./alertmanager-secret-k8sdd.yaml</span><br></pre></td></tr></table></figure>
<p>上述方法我感觉是钉钉插件镜像的代码问题，镜像作者也很久未更新了，所以暂时放弃service方式访问</p>
<h2 id="企业微信报警"><a href="#企业微信报警" class="headerlink" title="企业微信报警"></a>企业微信报警</h2><p>后续的所有操作都可在以下GitHub地址找到<br><a target="_blank" rel="noopener" href="https://github.com/huisebug/Prometheus-Operator">https://github.com/huisebug/Prometheus-Operator</a><br>后续演示的还是基于官方的github来操作</p>
<h3 id="建立企业微信账户"><a href="#建立企业微信账户" class="headerlink" title="建立企业微信账户"></a>建立企业微信账户</h3><p>step 1: 访问网站<a target="_blank" rel="noopener" href="https://work.weixin.qq.com/">https://work.weixin.qq.com/</a> 注册企业微信账号（不需要企业认证）。<br>step 2: 访问apps 创建应用，点击 创建应用按钮 -&gt; 填写应用信息：</p>
<p><img src="/2019/08/27/Prometheus-Operator/media/2167460f7929e9f8d6b804602d053162.png"></p>
<p>如果有则忽略</p>
<h3 id="修改alertmanager-yaml内容-2"><a href="#修改alertmanager-yaml内容-2" class="headerlink" title="修改alertmanager.yaml内容"></a>修改alertmanager.yaml内容</h3><p>此处需要修改kube-prometheus/manifests/alertmanager-secret.yaml文件，其中的data数据是经过base64加密的，复制出来随便去一个base64解码即可看到。或者运行下面的命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat alertmanager-secret.yaml | grep alertmanager.yaml | cut -f 2- -d &quot;:&quot; | tr -d &quot; &quot; | base64 –d</span><br></pre></td></tr></table></figure>
<p><img src="/2019/08/27/Prometheus-Operator/media/ce16fd528480ca5dc6accbe565813805.png"></p>
<p>我们需要将secret中的alertmanager.yaml修改为如下的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  resolve_timeout: 1h</span><br><span class="line">route:</span><br><span class="line">  group_by: [&#x27;alertname&#x27;]</span><br><span class="line">  receiver: &#x27;wechat&#x27;</span><br><span class="line">  group_wait: 30s</span><br><span class="line">  group_interval: 30s</span><br><span class="line">  repeat_interval: 10m</span><br><span class="line"></span><br><span class="line">receivers:</span><br><span class="line">- name: &#x27;wechat&#x27;</span><br><span class="line">  wechat_configs:</span><br><span class="line">  - corp_id: &#x27;企业ID&#x27;</span><br><span class="line">    to_party: &#x27;组ID&#x27;</span><br><span class="line">    agent_id: &#x27;应用ID&#x27;</span><br><span class="line">    api_secret: &#x27;应用密钥&#x27;</span><br><span class="line">    #是否发送恢复信息</span><br><span class="line">    send_resolved: true</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>  corp_id: 企业微信账号唯一 ID， 可以在”我的企业”中查看。</li>
<li>  to_party: 需要发送的组(部门ID)。即<br><img src="/2019/08/27/Prometheus-Operator/media/a5971d9b5aec90857f23a49be18077d8.png"></li>
<li>  agent_id: 第三方企业应用的 ID，可以在自己创建的第三方企业应用详情页面查看。</li>
<li>  api_secret:第三方企业应用的密钥，可以在自己创建的第三方企业应用详情页面查看。<br><img src="/2019/08/27/Prometheus-Operator/media/09f014e63904cbd46b50e91e05cf679b.png"><br>将上面修改好的内容进行base64加密，然后copy到alertmanager-secret.yaml中，然后在alertmanager web页面进行查看</li>
</ul>
<p><img src="/2019/08/27/Prometheus-Operator/media/53c9c0f213c0f6922474fae21b5d5048.png"></p>
<h3 id="建立资源类型PrometheusRule"><a href="#建立资源类型PrometheusRule" class="headerlink" title="建立资源类型PrometheusRule"></a>建立资源类型PrometheusRule</h3><p>默认的在建立<a target="_blank" rel="noopener" href="https://github.com/huisebug/Prometheus-Operator">Prometheus-Operator</a>时候会建立官方推荐的一些告警规则，为便于测试，可暂时删除prometheus-rules.yaml中的资源类型PrometheusRule规则</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=./kubeconfig/sre.kubeconfig delete -f kube-prometheus/manifests/prometheus-rules.yaml</span><br></pre></td></tr></table></figure>
<p>然后执行我新建的一些简单告警规则资源类型PrometheusRule（服务状态规则，mysql服务状态规则）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=./kubeconfig/sre.kubeconfig apply -f kube-prometheus/manifests/new/mysql-rules.yaml</span><br><span class="line">kubectl --kubeconfig=./kubeconfig/sre.kubeconfig apply -f kube-prometheus/manifests/new/state-rules.yaml</span><br></pre></td></tr></table></figure>
<p><img src="/2019/08/27/Prometheus-Operator/media/c601e3e34c2264ac2a41bb0ce001479f.png"></p>
<h3 id="建立对应的告警目标服务"><a href="#建立对应的告警目标服务" class="headerlink" title="建立对应的告警目标服务"></a>建立对应的告警目标服务</h3><p>根据上面我们建立的告警规则，我们需要建立mysql服务，mysql监控服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=./kubeconfig/sre.kubeconfig apply -f kube-prometheus/manifests/new/mysql-rc.yaml</span><br><span class="line">kubectl --kubeconfig=./kubeconfig/sre.kubeconfig apply -fkube-prometheus/manifests/new/mysql-exporter.yaml</span><br></pre></td></tr></table></figure>
<p><img src="/2019/08/27/Prometheus-Operator/media/fa3d85ccd71b489a0321dde1c4f61e60.png"></p>
<p>在prometheus web页面查看</p>
<p><img src="/2019/08/27/Prometheus-Operator/media/eeb84e617080aab07e887b6019149aa5.png"></p>
<h3 id="验证告警效果"><a href="#验证告警效果" class="headerlink" title="验证告警效果"></a>验证告警效果</h3><p>注意验证方法，MySQL服务自身是没有提供metrics，是依靠mysql-exporter这个服务去收集的，所以当MySQL服务无法访问的时候才能实现mysql告警，MySQL-exporter服务停止是服务停止告警，此处我需要将mysql服务的service配置删除，已达到服务无法访问的效果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl.exe --kubeconfig=./kubeconfig/sre.kubeconfig get svc</span><br><span class="line">kubectl.exe --kubeconfig=./kubeconfig/sre.kubeconfig delete svc mysql-svc</span><br></pre></td></tr></table></figure>
<p><img src="/2019/08/27/Prometheus-Operator/media/859214249b15ec19e6978a18afffb9cd.png"></p>
<p>30秒后就可以在两个控制台分别看到如下</p>
<p><img src="/2019/08/27/Prometheus-Operator/media/5d43c62772602e2c81ec114cb7f27e73.png"></p>
<p><img src="/2019/08/27/Prometheus-Operator/media/475bccb776141ea2327393e1b47eeea0.png"></p>
<p>企业微信客户端收到错误告警如下</p>
<p><img src="/2019/08/27/Prometheus-Operator/media/cb724f3a8955de683842e386b32611a3.png"></p>
<p>重新建立svc，验证恢复告警</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=./kubeconfig/sre.kubeconfig apply -f kube-prometheus/manifests/new/mysql-rc.yaml</span><br></pre></td></tr></table></figure>
<p><img src="/2019/08/27/Prometheus-Operator/media/0a9bb4b8c8f002f2129e10f3de548ac6.png"></p>
<p>总结：</p>
<ul>
<li>  告警信息太多，太杂乱</li>
<li>  错误告警和恢复告警基本内容差不多，无法区别</li>
<li>  需要自定义告警模板来便于快速定位</li>
</ul>
<h3 id="建立自定义告警模板"><a href="#建立自定义告警模板" class="headerlink" title="建立自定义告警模板"></a>建立自定义告警模板</h3><h4 id="alertmanager-temp-configmap-yaml"><a href="#alertmanager-temp-configmap-yaml" class="headerlink" title="alertmanager-temp-configmap.yaml"></a>alertmanager-temp-configmap.yaml</h4><p><img src="/2019/08/27/Prometheus-Operator/media/9faa737a345f90cacdad094721bb64a0.png"></p>
<p>上面的模板是使用的gotemplate语法编写，其中包含了错误告警和恢复告警，具体编写请参考以下链接<br><a target="_blank" rel="noopener" href="https://github.com/songjiayang/prometheus_practice/issues/12">https://github.com/songjiayang/prometheus_practice/issues/12</a></p>
<h4 id="修改alertmanager-yaml内容-3"><a href="#修改alertmanager-yaml内容-3" class="headerlink" title="修改alertmanager.yaml内容"></a>修改alertmanager.yaml内容</h4><p>我们需要将secret中的alertmanager.yaml修改为如下的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  resolve_timeout: 1h</span><br><span class="line">route:</span><br><span class="line">  group_by: [&#x27;alertname&#x27;]</span><br><span class="line">  receiver: &#x27;wechat&#x27;</span><br><span class="line">  group_wait: 30s</span><br><span class="line">  group_interval: 30s</span><br><span class="line">  repeat_interval: 10m</span><br><span class="line"></span><br><span class="line">receivers:</span><br><span class="line">- name: &#x27;wechat&#x27;</span><br><span class="line">  wechat_configs:</span><br><span class="line">  - corp_id: &#x27;企业ID&#x27;</span><br><span class="line">    to_party: &#x27;组ID&#x27;</span><br><span class="line">    agent_id: &#x27;应用ID&#x27;</span><br><span class="line">    api_secret: &#x27;应用密钥&#x27;</span><br><span class="line">    #是否发送恢复信息</span><br><span class="line">    send_resolved: true</span><br><span class="line"><span class="meta">#</span><span class="bash">告警模板</span></span><br><span class="line">templates: </span><br><span class="line">- &#x27;/etc/alertmanager/configmaps/alertmanager-temp/temp.yaml&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>  templates：指定告警模板的存放位置，注意此处的路径是固定格式的/etc/alertmanager/configmaps/+configmap名称+configmap中的键名，即我在new目录下的alertmanager-temp-configmap.yaml，如下：</li>
</ul>
<p><img src="/2019/08/27/Prometheus-Operator/media/1fee93d395693c7b04f1a47da3bea884.png"></p>
<p><img src="/2019/08/27/Prometheus-Operator/media/dd755c752ef27bee10ea902010d5999e.png"></p>
<p>将上面修改好的内容进行base64加密，然后copy到alertmanager-secret.yaml中，然后在alertmanager web页面进行查看</p>
<p><img src="/2019/08/27/Prometheus-Operator/media/4f1cddad3f49bcfa1aa08e5381026785.png"></p>
<h4 id="alertmanager服务添加configmap挂载"><a href="#alertmanager服务添加configmap挂载" class="headerlink" title="alertmanager服务添加configmap挂载"></a>alertmanager服务添加configmap挂载</h4><p>alertmanager服务的建立是statefulset建立的，是依据alertmanager-alertmanager.yaml文件建立的，需要增加自定义模板的configmap挂载，并且默认是挂载到/etc/alertmanager/configmaps/下的，可参照官方介绍<a target="_blank" rel="noopener" href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#alertmanagerspec">https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#alertmanagerspec</a></p>
<p>修改如下：</p>
<p><img src="/2019/08/27/Prometheus-Operator/media/a47fde5295cd130d94772a0223d818cc.png"></p>
<p>所以需要重新建立alertmanager服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=./kubeconfig/sre.kubeconfig apply -f kube-prometheus/manifests/alertmanager-alertmanager.yaml</span><br></pre></td></tr></table></figure>
<p>再次验证告警效果，同样的删除mysql的svc。企业微信效果如下</p>
<p><img src="/2019/08/27/Prometheus-Operator/media/8d5ab49247e0cc6611fe0f1dda7ba020.png"></p>
<p><img src="/2019/08/27/Prometheus-Operator/media/d02e70173936e3774b30232d105fc185.png"></p>
<h2 id="企业微信-QQmail同时报警"><a href="#企业微信-QQmail同时报警" class="headerlink" title="企业微信/QQmail同时报警"></a>企业微信/QQmail同时报警</h2><p>配置文件如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  resolve_timeout: 1h</span><br><span class="line">  smtp_smarthost: &#x27;smtp.qq.com:587&#x27;</span><br><span class="line">  smtp_from: &#x27;发件人&#x27;     </span><br><span class="line">  smtp_auth_username: &#x27;发件人&#x27;   </span><br><span class="line">  smtp_auth_password: &#x27;授权码&#x27;  </span><br><span class="line"></span><br><span class="line">route:</span><br><span class="line">  group_by: [&#x27;alertname&#x27;] </span><br><span class="line">  group_wait: 30s</span><br><span class="line">  group_interval: 30s</span><br><span class="line">  repeat_interval: 10m</span><br><span class="line">  receiver: &#x27;huisebug&#x27;</span><br><span class="line">  routes:</span><br><span class="line">  - receiver: &#x27;wechat&#x27;</span><br><span class="line">    continue: true</span><br><span class="line">  - receiver: &#x27;huisebug&#x27;</span><br><span class="line">    continue: true</span><br><span class="line"></span><br><span class="line">receivers:</span><br><span class="line">- name: &#x27;huisebug&#x27;  </span><br><span class="line">  email_configs:</span><br><span class="line">  - to: &#x27;收件人&#x27;</span><br><span class="line">    send_resolved: true</span><br><span class="line">- name: &#x27;wechat&#x27;</span><br><span class="line">  wechat_configs:</span><br><span class="line">  - corp_id: &#x27;&#x27;</span><br><span class="line">    to_party: &#x27;8&#x27;</span><br><span class="line">    agent_id: &#x27;1000009&#x27;</span><br><span class="line">    api_secret: &#x27;&#x27;</span><br><span class="line">    send_resolved: true</span><br><span class="line">    </span><br><span class="line">templates: </span><br><span class="line">- &#x27;/etc/alertmanager/configmaps/alertmanager-temp/temp.yaml&#x27;</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">huisebug</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://huisebug.github.io/2019/08/27/Prometheus-Operator/">https://huisebug.github.io/2019/08/27/Prometheus-Operator/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://huisebug.github.io" target="_blank">huisebug</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/k8s/">k8s</a><a class="post-meta__tags" href="/tags/prometheus/">prometheus</a><a class="post-meta__tags" href="/tags/alertmanager/">alertmanager</a><a class="post-meta__tags" href="/tags/grafana/">grafana</a><a class="post-meta__tags" href="/tags/mysql-export/">mysql-export</a><a class="post-meta__tags" href="/tags/%E9%92%89%E9%92%89%E5%91%8A%E8%AD%A6/">钉钉告警</a><a class="post-meta__tags" href="/tags/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E5%91%8A%E8%AD%A6/">企业微信告警</a></div><div class="post_share"><div class="social-share" data-image="/img/prometheus.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2019/08/28/k8s-hpa/"><img class="prev-cover" src="/img/head.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Kubernetes-hpav2横向自动扩容</div></div></a></div><div class="next-post pull-right"><a href="/2019/05/24/mysql-mycat/"><img class="next-cover" src="/img/mysql.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">mysql5.7主从复制及mycat1.6读写分离</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/12/15/prometheus-operator告警场景/" title="Prometheus-Operator告警场景"><img class="cover" src="/img/head.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-15</div><div class="title">Prometheus-Operator告警场景</div></div></a></div><div><a href="/2019/03/06/prometheus/" title="prometheus监控单一服务及告警"><img class="cover" src="/img/prometheus.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-03-06</div><div class="title">prometheus监控单一服务及告警</div></div></a></div><div><a href="/2018/09/06/k8s常见方法及错误解决/" title="持续更新-20190306-k8s常见方法及错误解决"><img class="cover" src="/img/head.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-09-06</div><div class="title">持续更新-20190306-k8s常见方法及错误解决</div></div></a></div><div><a href="/2021/07/06/kata容器的一些分享/" title="kata容器的一些分享"><img class="cover" src="/img/kata.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-06</div><div class="title">kata容器的一些分享</div></div></a></div><div><a href="/2020/12/15/k8s高版本服务部署yaml/" title="k8s集群高版本1.18以上常见服务部署yaml"><img class="cover" src="/img/head.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-15</div><div class="title">k8s集群高版本1.18以上常见服务部署yaml</div></div></a></div><div><a href="/2019/05/08/gluster-heketi-efk/" title="heketi安装结合EFK实践"><img class="cover" src="/img/head.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-05-08</div><div class="title">heketi安装结合EFK实践</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/linuxqie.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">huisebug</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">23</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">59</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/huisebug"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/huisebug" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:huisebug@aliyun.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">贯彻容器搬砖化 提供有偿技术支援 请联系QQ-1139873783</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Prometheus-operator"><span class="toc-number">1.</span> <span class="toc-text">Prometheus-operator </span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85monitoring-coreos-com-v1-api%EF%BC%88prometheus-operator%EF%BC%89"><span class="toc-number">1.1.</span> <span class="toc-text">安装monitoring.coreos.com&#x2F;v1 api（prometheus-operator）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="toc-number">1.2.</span> <span class="toc-text">集群状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB"><span class="toc-number">1.3.</span> <span class="toc-text">问题汇总</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90prometheus-operator%E5%8E%9F%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">解析prometheus-operator原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#yaml%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.1.</span> <span class="toc-text">yaml类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E6%98%93%E5%8E%9F%E7%90%86"><span class="toc-number">2.2.</span> <span class="toc-text">简易原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E7%B1%BB%E5%9E%8BPrometheus"><span class="toc-number">2.3.</span> <span class="toc-text">资源类型Prometheus</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E7%B1%BB%E5%9E%8BPrometheusRule"><span class="toc-number">2.4.</span> <span class="toc-text">资源类型PrometheusRule</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E7%B1%BB%E5%9E%8BServiceMonitor"><span class="toc-number">2.5.</span> <span class="toc-text">资源类型ServiceMonitor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1Alertmanagers"><span class="toc-number">2.6.</span> <span class="toc-text">资源对象Alertmanagers</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E6%95%88%E6%9E%9C"><span class="toc-number">3.</span> <span class="toc-text">验证效果</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#grafana-huisebug-com"><span class="toc-number">3.1.</span> <span class="toc-text">grafana.huisebug.com</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#prometheus-huisebug-com"><span class="toc-number">3.2.</span> <span class="toc-text">prometheus.huisebug.com</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#metrics"><span class="toc-number">4.</span> <span class="toc-text">metrics</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3scheduler%E5%92%8Ccontroller-manager%E7%9A%84metric"><span class="toc-number">4.1.</span> <span class="toc-text">解决scheduler和controller-manager的metric</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql-metrics"><span class="toc-number">4.2.</span> <span class="toc-text">mysql-metrics</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A6%96%E5%85%88%E5%BB%BA%E7%AB%8B%E4%B8%80%E4%B8%AAmysql%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.2.1.</span> <span class="toc-text">首先建立一个mysql服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8helm%E6%96%B9%E5%BC%8F%E5%AE%89%E8%A3%85mysql-exporter"><span class="toc-number">4.2.2.</span> <span class="toc-text">使用helm方式安装mysql-exporter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AEmysql-exporter%E6%98%AF%E5%90%A6%E6%9C%89metric%E7%94%9F%E6%88%90"><span class="toc-number">4.2.3.</span> <span class="toc-text">访问mysql-exporter是否有metric生成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ServiceMonitor%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1%E5%BB%BA%E7%AB%8B"><span class="toc-number">4.2.4.</span> <span class="toc-text">ServiceMonitor资源对象建立</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Prometheus%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1%E5%BB%BA%E7%AB%8B"><span class="toc-number">4.2.5.</span> <span class="toc-text">Prometheus资源对象建立</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E6%95%88%E6%9E%9C-1"><span class="toc-number">4.2.6.</span> <span class="toc-text">验证效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#traefik-metrics"><span class="toc-number">4.3.</span> <span class="toc-text">traefik-metrics</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#metrics%E5%BB%BA%E7%AB%8B"><span class="toc-number">4.3.1.</span> <span class="toc-text">metrics建立</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ServiceMonitor%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1%E5%BB%BA%E7%AB%8B-1"><span class="toc-number">4.3.2.</span> <span class="toc-text">ServiceMonitor资源对象建立</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E6%95%88%E6%9E%9C-2"><span class="toc-number">4.3.3.</span> <span class="toc-text">验证效果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#alertmanager%E5%91%8A%E8%AD%A6"><span class="toc-number">5.</span> <span class="toc-text">alertmanager告警</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%92%89%E9%92%89webhook%E6%8A%A5%E8%AD%A62-0%E7%89%88%E6%9C%AC8060"><span class="toc-number">5.1.</span> <span class="toc-text">钉钉webhook报警2.0版本8060</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%92%89%E9%92%89%E6%8F%92%E4%BB%B6"><span class="toc-number">5.1.1.</span> <span class="toc-text">安装钉钉插件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%A9%E7%90%86%E6%9C%BA%E5%AE%89%E8%A3%85"><span class="toc-number">5.1.1.1.</span> <span class="toc-text">物理机安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Docker%E5%8D%95%E6%9C%BA%E5%AE%B9%E5%99%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">5.1.1.2.</span> <span class="toc-text">Docker单机容器部署</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%92%89%E9%92%89webhook-%E5%AE%B9%E5%99%A8%E5%BB%BA%E7%AB%8B"><span class="toc-number">5.1.1.2.1.</span> <span class="toc-text">钉钉webhook 容器建立</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9alertmanager-yaml%E5%86%85%E5%AE%B9"><span class="toc-number">5.1.1.2.2.</span> <span class="toc-text">修改alertmanager.yaml内容</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E4%BF%AE%E6%94%B9%E5%90%8E%E7%9A%84secret%E6%96%87%E4%BB%B6"><span class="toc-number">6.</span> <span class="toc-text">执行修改后的secret文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%96%B9%E5%BC%8F%E9%83%A8%E7%BD%B2"><span class="toc-number">6.0.0.1.</span> <span class="toc-text">集群方式部署</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#hostnetwork%E6%96%B9%E5%BC%8F%E8%AE%BF%E9%97%AE"><span class="toc-number">6.0.0.1.1.</span> <span class="toc-text">hostnetwork方式访问</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#service%E6%96%B9%E5%BC%8F%E8%AE%BF%E9%97%AE"><span class="toc-number">6.0.0.1.2.</span> <span class="toc-text">service方式访问</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9alertmanager-yaml%E5%86%85%E5%AE%B9-1"><span class="toc-number">6.0.0.1.2.1.</span> <span class="toc-text">修改alertmanager.yaml内容</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%8A%A5%E8%AD%A6"><span class="toc-number">6.1.</span> <span class="toc-text">企业微信报警</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E8%B4%A6%E6%88%B7"><span class="toc-number">6.1.1.</span> <span class="toc-text">建立企业微信账户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9alertmanager-yaml%E5%86%85%E5%AE%B9-2"><span class="toc-number">6.1.2.</span> <span class="toc-text">修改alertmanager.yaml内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E8%B5%84%E6%BA%90%E7%B1%BB%E5%9E%8BPrometheusRule"><span class="toc-number">6.1.3.</span> <span class="toc-text">建立资源类型PrometheusRule</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E5%AF%B9%E5%BA%94%E7%9A%84%E5%91%8A%E8%AD%A6%E7%9B%AE%E6%A0%87%E6%9C%8D%E5%8A%A1"><span class="toc-number">6.1.4.</span> <span class="toc-text">建立对应的告警目标服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E5%91%8A%E8%AD%A6%E6%95%88%E6%9E%9C"><span class="toc-number">6.1.5.</span> <span class="toc-text">验证告警效果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E5%91%8A%E8%AD%A6%E6%A8%A1%E6%9D%BF"><span class="toc-number">6.1.6.</span> <span class="toc-text">建立自定义告警模板</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#alertmanager-temp-configmap-yaml"><span class="toc-number">6.1.6.1.</span> <span class="toc-text">alertmanager-temp-configmap.yaml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9alertmanager-yaml%E5%86%85%E5%AE%B9-3"><span class="toc-number">6.1.6.2.</span> <span class="toc-text">修改alertmanager.yaml内容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#alertmanager%E6%9C%8D%E5%8A%A1%E6%B7%BB%E5%8A%A0configmap%E6%8C%82%E8%BD%BD"><span class="toc-number">6.1.6.3.</span> <span class="toc-text">alertmanager服务添加configmap挂载</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1-QQmail%E5%90%8C%E6%97%B6%E6%8A%A5%E8%AD%A6"><span class="toc-number">6.2.</span> <span class="toc-text">企业微信&#x2F;QQmail同时报警</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/08/03/kubernetesalias/" title="kubernetesalias:kubernetes封装命令工具"><img src="/img/kubernetesalias.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="kubernetesalias:kubernetes封装命令工具"/></a><div class="content"><a class="title" href="/2023/08/03/kubernetesalias/" title="kubernetesalias:kubernetes封装命令工具">kubernetesalias:kubernetes封装命令工具</a><time datetime="2023-08-03T08:04:01.000Z" title="发表于 2023-08-03 16:04:01">2023-08-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/28/kube-prometheus-thanos/" title="kube-prometheus+thanos 多集群prometheus方案存储方案"><img src="/img/kube-prometheus-thanos.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="kube-prometheus+thanos 多集群prometheus方案存储方案"/></a><div class="content"><a class="title" href="/2023/06/28/kube-prometheus-thanos/" title="kube-prometheus+thanos 多集群prometheus方案存储方案">kube-prometheus+thanos 多集群prometheus方案存储方案</a><time datetime="2023-06-28T03:04:01.000Z" title="发表于 2023-06-28 11:04:01">2023-06-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/05/wait-injection/" title="wait-injection服务依赖等待注入"><img src="/img/wait-injection.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="wait-injection服务依赖等待注入"/></a><div class="content"><a class="title" href="/2023/05/05/wait-injection/" title="wait-injection服务依赖等待注入">wait-injection服务依赖等待注入</a><time datetime="2023-05-05T03:04:01.000Z" title="发表于 2023-05-05 11:04:01">2023-05-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/02/07/kube-deploymentimage/" title="kube-deploymentimage:k8simage-operator改良版本"><img src="/img/kube-deploymentimage.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="kube-deploymentimage:k8simage-operator改良版本"/></a><div class="content"><a class="title" href="/2023/02/07/kube-deploymentimage/" title="kube-deploymentimage:k8simage-operator改良版本">kube-deploymentimage:k8simage-operator改良版本</a><time datetime="2023-02-07T03:04:01.000Z" title="发表于 2023-02-07 11:04:01">2023-02-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/09/logfile-operator/" title="logfile-operator:服务日志系统收集多方案"><img src="/img/logfile-operator.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="logfile-operator:服务日志系统收集多方案"/></a><div class="content"><a class="title" href="/2022/12/09/logfile-operator/" title="logfile-operator:服务日志系统收集多方案">logfile-operator:服务日志系统收集多方案</a><time datetime="2022-12-09T03:04:01.000Z" title="发表于 2022-12-09 11:04:01">2022-12-09</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/prometheus.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2023 By huisebug</div><div class="footer_custom_text">huisebug探索中</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>