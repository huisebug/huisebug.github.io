<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Docker-machine+Docker swarm+Nginx+Nginx代理 | huisebug</title><meta name="keywords" content="docker,jenkins,expect脚本,docker machine,docker swarm"><meta name="author" content="huisebug"><meta name="copyright" content="huisebug"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="这是一个swarm集群，从零开始搭建服务器环境，Docker-machine+Docker swarm+Nginx+Nginx代理">
<meta property="og:type" content="article">
<meta property="og:title" content="Docker-machine+Docker swarm+Nginx+Nginx代理">
<meta property="og:url" content="https://huisebug.github.io/2017/12/19/docker-swarm/index.html">
<meta property="og:site_name" content="huisebug">
<meta property="og:description" content="这是一个swarm集群，从零开始搭建服务器环境，Docker-machine+Docker swarm+Nginx+Nginx代理">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://huisebug.github.io/img/docker.jpg">
<meta property="article:published_time" content="2017-12-19T09:04:01.000Z">
<meta property="article:modified_time" content="2021-07-09T02:59:43.102Z">
<meta property="article:author" content="huisebug">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="jenkins">
<meta property="article:tag" content="expect脚本">
<meta property="article:tag" content="docker machine">
<meta property="article:tag" content="docker swarm">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://huisebug.github.io/img/docker.jpg"><link rel="shortcut icon" href="/img/linuxqie.jpg"><link rel="canonical" href="https://huisebug.github.io/2017/12/19/docker-swarm/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: huisebug","link":"链接: ","source":"来源: huisebug","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Docker-machine+Docker swarm+Nginx+Nginx代理',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-07-09 10:59:43'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="huisebug" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/linuxqie.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">67</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/download/"><i class="fa-fw fas fa-folder-open"></i><span> Download</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/docker.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">huisebug</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/download/"><i class="fa-fw fas fa-folder-open"></i><span> Download</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Docker-machine+Docker swarm+Nginx+Nginx代理</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2017-12-19T09:04:01.000Z" title="发表于 2017-12-19 17:04:01">2017-12-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-07-09T02:59:43.102Z" title="更新于 2021-07-09 10:59:43">2021-07-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Docker/">Docker</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Docker-machine+Docker swarm+Nginx+Nginx代理"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>这是一个swarm集群，从零开始搭建服务器环境，Docker-machine+Docker swarm+Nginx+Nginx代理</p>
<span id="more"></span>



<h1 id="Docker-machine-Docker-swarm-Nginx-Nginx代理"><a href="#Docker-machine-Docker-swarm-Nginx-Nginx代理" class="headerlink" title="Docker-machine+Docker swarm+Nginx+Nginx代理"></a>Docker-machine+Docker swarm+Nginx+Nginx代理</h1><h2 id="准备环境："><a href="#准备环境：" class="headerlink" title="准备环境："></a>准备环境：</h2><ul>
<li> 6台centos7操作系统（需要关闭防火墙，关闭selinux）</li>
</ul>
<p><img src="/2017/12/19/docker-swarm/media/86bdee66a4904907a8cfb23411ec6a20.png"></p>
<ul>
<li> IP地址划分</li>
</ul>
<table>
<thead>
<tr>
<th>Docker-machine</th>
<th>Swarm node1</th>
<th>Swarm node1</th>
<th>Swarm node1</th>
<th>Nginx服务</th>
<th>Nginx代理</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.100.70</td>
<td>192.168.100.71</td>
<td>192.168.100.72</td>
<td>192.168.100.73</td>
<td>192.168.100.74</td>
<td>192.168.100.75</td>
</tr>
</tbody></table>
<ul>
<li><p> docker版本</p>
</li>
<li><p> 初始环境要求：</p>
</li>
</ul>
<p>准备的是全新的操作系统，只需IP地址配置ok，全网可以互通。</p>
<h2 id="项目执行之前需要实现的要求"><a href="#项目执行之前需要实现的要求" class="headerlink" title="项目执行之前需要实现的要求"></a>项目执行之前需要实现的要求</h2><ul>
<li><p>  全部不使用root，关闭密码验证，使用ssh密钥进行验证。</p>
</li>
<li><p>  全部机器使用IP地址为70的这台作为堡垒机进行管理。</p>
</li>
<li><p>  要求nginx代理为外部的提供访问的地址，（如果允许，可以再搭建一台dns解析服务和使用一台win7来进行测试。）</p>
</li>
<li><p>  后续更多需求可根据实际进行添加。</p>
</li>
</ul>
<h2 id="修改不使用root，使用新用户admin操作"><a href="#修改不使用root，使用新用户admin操作" class="headerlink" title="修改不使用root，使用新用户admin操作"></a>修改不使用root，使用新用户admin操作</h2><h3 id="远程软件连接"><a href="#远程软件连接" class="headerlink" title="远程软件连接"></a>远程软件连接</h3><p>使用终端软件连接，暂时没有关闭密钥验证和不使用root登录，所以使用root先登录</p>
<p><img src="/2017/12/19/docker-swarm/media/7122132bd524c46f401e4ceeb021940f.png"></p>
<h3 id="上传expect脚本"><a href="#上传expect脚本" class="headerlink" title="上传expect脚本"></a>上传expect脚本</h3><p>将我当初写的expect脚本复制到作为堡垒机的100.70这台服务器</p>
<p><img src="/2017/12/19/docker-swarm/media/d0ba236e97aed08cf0d7189e3275e8f6.png"></p>
<h4 id="简介："><a href="#简介：" class="headerlink" title="简介："></a>简介：</h4><ul>
<li>login.exp：里面包含了登录、新建用户、授权sudo使用权限、设置用户密码、复制公钥到新建用户的ssh目录下并关闭sshd服务的端口号和禁止密码验证登录操作。</li>
<li>scp.exp：里面包含了将公钥上传到指定的服务器的指定目录下，以便提供给login.exp登录进行操作。</li>
<li>sshlogin.sh:这里定义的是exp脚本中将会使用位置变量的参数，在这里定义后，exp脚本可以引用shell脚本的变量。</li>
<li>wyf.pub：这是公钥文件，自己去生成一个</li>
<li>passwd.txt：这个是shell脚本sshlogin.sh使用for循环的时候会使用到的各个位置变量的参数值。</li>
<li>use.txt：中文操作手册<h4 id="文件内容："><a href="#文件内容：" class="headerlink" title="文件内容："></a>文件内容：</h4></li>
</ul>
<p>login.exp</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/usr/bin/expect -f</span></span><br><span class="line"></span><br><span class="line">set ipaddress [lindex $argv 0]</span><br><span class="line"></span><br><span class="line">set passwd [lindex $argv 1]</span><br><span class="line"></span><br><span class="line">set user [lindex $argv 2]</span><br><span class="line"></span><br><span class="line">set pubkey [lindex $argv 3]</span><br><span class="line"></span><br><span class="line">set sshport [lindex $argv 4]</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">set</span> sudo <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$user</span> ALL=(ALL) ALL</span></span></span><br><span class="line"></span><br><span class="line">set timeout 30</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string">登入操作</span></span></span><br><span class="line">spawn ssh root@$ipaddress</span><br><span class="line"></span><br><span class="line">expect &#123;</span><br><span class="line">&quot;yes/no&quot; &#123; send &quot;yes\r&quot;;exp_continue &#125;</span><br><span class="line">&quot;password:&quot; &#123; send &quot;$passwd\r&quot; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">expect &#123;</span><br><span class="line">&quot;*from*&quot; &#123;</span><br><span class="line">send &quot;useradd $user -m -s /bin/bash\r&quot;</span><br><span class="line">send &quot;echo &#x27;$user ALL=(ALL) ALL&#x27; &gt;&gt; /etc/sudoers\r&quot;</span><br><span class="line">send &quot;chown $user: /tmp/$pubkey\r&quot;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string">修改用户密码</span></span></span><br><span class="line">send &quot;passwd $user\r&quot;</span><br><span class="line">expect &#123;</span><br><span class="line">&quot;UNIX&quot; &#123; send &quot;pwD@1234\r&quot;;exp_continue&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">expect &#123;</span><br><span class="line">&quot;#&quot; &#123; send &quot;su - $user\r&quot;</span><br><span class="line">send &quot;mkdir -p /home/$user/.ssh/\r&quot;</span><br><span class="line">send &quot;chmod 700 /home/$user/.ssh\r&quot;</span><br><span class="line">send &quot;cat /tmp/$pubkey &gt; /home/$user/.ssh/authorized_keys\r&quot;</span><br><span class="line">send &quot;chmod 600 /home/$user/.ssh/authorized_keys\r&quot;</span><br><span class="line">send &quot;exit\r&quot;</span><br><span class="line">send &quot;sed -i &#x27;s/#Port 22/Port $sshport/&#x27; /etc/ssh/sshd_config\r&quot;</span><br><span class="line">send &quot;sed -i &#x27;s/Port 22/Port $sshport/&#x27; /etc/ssh/sshd_config\r&quot;</span><br><span class="line">send &quot;sed -i &#x27;s/PasswordAuthentication yes/PasswordAuthentication no/&#x27; /etc/ssh/sshd_config\r&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string">send &quot;</span>systemctl restart sshd\r<span class="string">&quot;</span></span></span><br><span class="line">send &quot;exit\r&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">interact</span><br></pre></td></tr></table></figure>
<p>scp.exp</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/usr/bin/expect -f</span></span><br><span class="line"></span><br><span class="line">set ipaddress [lindex $argv 0]</span><br><span class="line"></span><br><span class="line">set passwd [lindex $argv 1]</span><br><span class="line"></span><br><span class="line">set user [lindex $argv 2]</span><br><span class="line"></span><br><span class="line">set pubkey [lindex $argv 3]</span><br><span class="line"></span><br><span class="line">set timeout 30</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">上传密钥wyf</span></span><br><span class="line">spawn scp $pubkey root@$ipaddress:/tmp/</span><br><span class="line"></span><br><span class="line">expect &#123;</span><br><span class="line">&quot;yes/no&quot; &#123; send &quot;yes\r&quot;&#125;</span><br><span class="line">&quot;password:&quot; &#123; send &quot;$passwd\r&quot; &#125;</span><br><span class="line">&quot;#&quot; &#123; send &quot;exit\r&quot; &#125;&#125;</span><br><span class="line">interact</span><br><span class="line"><span class="meta">#</span><span class="bash">expect <span class="string">&quot;<span class="variable">$pubkey</span>&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>sshlogin.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">for i in `awk &#x27;&#123;print $1&#125;&#x27; $PWD/passwd.txt`</span><br><span class="line"></span><br><span class="line">do</span><br><span class="line"></span><br><span class="line">j=`awk -v I=&quot;$i&quot; &#x27;&#123;if(I==$1)print $2&#125;&#x27; $PWD/passwd.txt`</span><br><span class="line">u=`awk -v I=&quot;$i&quot; &#x27;&#123;if(I==$1)print $3&#125;&#x27; $PWD/passwd.txt`</span><br><span class="line">p=`awk -v I=&quot;$i&quot; &#x27;&#123;if(I==$1)print $4&#125;&#x27; $PWD/passwd.txt`</span><br><span class="line">port=`awk -v I=&quot;$i&quot; &#x27;&#123;if(I==$1)print $5&#x27; $PWD/passwd.txt`</span><br><span class="line">expect $PWD/scp.exp $i $j $u $p $port</span><br><span class="line">expect $PWD/login.exp $i $j $u $p $port</span><br><span class="line"></span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>wyf.pub </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-dss AAAAB3NzaC1kc3MAAACBANVB2rrIvkUGCJA6b/8h+GyKd1GVpxZFAM1n8sP2bo7TSkWpkxV81Y4zkdaYomsFDXLGnaI2QbHqv/pA0PndJFQ1NfYqbBw6FaGI1+cG8mgJBCPwVPmQnDvf4TPzJkEpdV1CK/wYjRVjuFL2lYOd8hepkNN4c96Dx5STdMyBSH+rAAAAFQCtUm3dYyX3j9pKY+yev3OKmB/LtwAAAIEAytEQ4hgceD7T00soGq/o0aS42QJoeZLJd/jwdIAqkUdg5y8q4lqzmlO2OaxD3YVf9eOYiuokZQu2qP5A+2iTbebpoqDDP8NksCgGPY+7viyKpUy+wrcm/Gwa0YA9B2mzpHudxXKuw/2wjtBKTjh+gFx7zlXBFHYaMdV8zsP/QkAAAACBALJc+rMJXSsS7+3i874iJIlP/r2qxrfkO4+qjmZoTbGYnhOzEzYbwP6newO27MBkaOHSPlWFh8kSQtiputcvg9GawG6Y6WO/0bfgHfxrDg0NnmQJgvcjMStGeuLwYB4NNG2KsomciN4hUruWHg0/+VwV8qknTHYFMJmOJC1ketuS</span><br></pre></td></tr></table></figure>

<p>passwd.txt</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.100.71 pwd@123 wyf5 wyf.pub 234</span><br></pre></td></tr></table></figure>

<p>use.txt</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">复制当前目录下的所有文件到同一个文件夹中</span><br><span class="line"></span><br><span class="line">只需要定义passwd.txt中的值即可</span><br><span class="line">格式为:列如像这样</span><br><span class="line">IP地址 root密码 新建用户名 公钥文件 sshd端口号</span><br><span class="line">192.168.100.71 pwd@123 wyf5 wyf.pub 234</span><br><span class="line"></span><br><span class="line">定义后执行sh脚本文件即可</span><br><span class="line"></span><br><span class="line">前置动作，yum -y install expect</span><br><span class="line">执行脚本的系统最好是使用英文的，不然在提示栏会显示中文。这是基于centos系统的</span><br></pre></td></tr></table></figure>
<h3 id="expect脚本的配置文件修改"><a href="#expect脚本的配置文件修改" class="headerlink" title="expect脚本的配置文件修改"></a>expect脚本的配置文件修改</h3><h4 id="将其他5台服务器的信息写到passwd文件中"><a href="#将其他5台服务器的信息写到passwd文件中" class="headerlink" title="将其他5台服务器的信息写到passwd文件中"></a>将其他5台服务器的信息写到passwd文件中</h4><p><img src="/2017/12/19/docker-swarm/media/629185cf57397b00b7234c6afd0b5250.png"></p>
<h4 id="安装expect脚本执行命令"><a href="#安装expect脚本执行命令" class="headerlink" title="安装expect脚本执行命令"></a>安装expect脚本执行命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install expect（这里我已经安装）</span><br></pre></td></tr></table></figure>
<p><img src="/2017/12/19/docker-swarm/media/4d71ec33e30dadbe02111c64f6de4a97.png"></p>
<h4 id="检查各脚本是否有错误的地方"><a href="#检查各脚本是否有错误的地方" class="headerlink" title="检查各脚本是否有错误的地方"></a>检查各脚本是否有错误的地方</h4><p>在login.exp这个脚本中重启sshd服务的操作，我注释掉了，先不重启，我们待会分别进去查看是否修改了配置文件，也是确保修改正确后再进行重启操作。<br><img src="/2017/12/19/docker-swarm/media/cad50107107cca9b8c4afd6578db5ebc.png"></p>
<p>执行过程中，因为中文支持的原因提示的密码输入不一样，所以将提示修改为这样的（这里可以看出操作系统不同，所提示的也不同，需要对应操作系统来修改这里）<br><img src="/2017/12/19/docker-swarm/media/dc58bc2891da1ea61b73f511044a026c.png"></p>
<p>因为操作系统的原因，每台sshd_config的配置文件也不同，比如centos7的port前面会有一个#号，其他系统可能不同;<br>所以我们可以修改写两个sed<br><img src="/2017/12/19/docker-swarm/media/12500c4ff12464e3cf99e06284290868.png"></p>
<p>还有一个问题需要说明，我这里写成了222端口是问题的，比如#port 22,第一次修改后为port 222，第二次又会匹配下一条sed，既会变成port 2222。所以尽量不要用22开头的作为修改后的端口号<br>执行后在查看其中一台<br><img src="/2017/12/19/docker-swarm/media/ff3c8af84f358c2699e7521e2b0bcab1.png"><br><img src="/2017/12/19/docker-swarm/media/4871a018365baf8ad513d591767eb01c.png"></p>
<p>后续重启sshd可能不成功，因为selinux和防火墙的原因，需要关闭。<br>查看无问题了，既重新启动sshd服务。</p>
<h3 id="分别登录admin账户"><a href="#分别登录admin账户" class="headerlink" title="分别登录admin账户"></a>分别登录admin账户</h3><p><img src="/2017/12/19/docker-swarm/media/44dc6033f8d46355e662feee96ad4f9a.png"><br><img src="/2017/12/19/docker-swarm/media/6f87f9585c9a4cc3064e5f9d9a32d7d5.png"></p>
<p>我这里的</p>
<ul>
<li>root密码是pwd@123</li>
<li>admin密码是qwaszx@）！&amp;</li>
<li>wyf公钥的密码是1836</li>
</ul>
<p>上面这里因为关闭了密钥验证，所以这里要使用密钥的验证。</p>
<h2 id="安装docker的等一系列服务"><a href="#安装docker的等一系列服务" class="headerlink" title="安装docker的等一系列服务"></a>安装docker的等一系列服务</h2><h3 id="新增项目测试："><a href="#新增项目测试：" class="headerlink" title="新增项目测试："></a>新增项目测试：</h3><h4 id="这里的100-70机器是全新的一台机器，当我们只安装docker-machine的时候看是否一定需要docker服务"><a href="#这里的100-70机器是全新的一台机器，当我们只安装docker-machine的时候看是否一定需要docker服务" class="headerlink" title="这里的100.70机器是全新的一台机器，当我们只安装docker-machine的时候看是否一定需要docker服务"></a>这里的100.70机器是全新的一台机器，当我们只安装docker-machine的时候看是否一定需要docker服务</h4><h5 id="查看三台节点服务器情况："><a href="#查看三台节点服务器情况：" class="headerlink" title="查看三台节点服务器情况："></a>查看三台节点服务器情况：</h5><p>验证并没有安装docker服务<br><img src="/2017/12/19/docker-swarm/media/944d126be5553a428ddc4dd77a209cc6.png"></p>
<p>上传docker-machine到服务器并移动到全局变量下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">ls</span></span><br><span class="line">docker-machine</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash">sudo mv docker-machine /usr/bin/</span></span><br><span class="line"><span class="meta">$</span><span class="bash">sudo chmod +x /usr/bin/docker-machine</span></span><br><span class="line"><span class="meta">$</span><span class="bash">docker-machine ls</span></span><br><span class="line">NAME ACTIVE DRIVER STATE URL SWARM DOCKER ERRORS</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash">docker-machine version</span></span><br><span class="line">docker-machine version 0.12.2, build 9371605</span><br></pre></td></tr></table></figure>
<p>先查看其他作为swarm集群的几台机器的情况</p>
<p><img src="/2017/12/19/docker-swarm/media/89e181f2d2aeb684fd0cc7c04115221e.png"><br><img src="/2017/12/19/docker-swarm/media/b2c1603f7279218e2064a1f0424a915f.png"><br><img src="/2017/12/19/docker-swarm/media/31482fe11be6a50646ffba08fa26145a.png"></p>
<p>可以看到上面的三个节点已经安装好了docker，</p>
<p>这里为什么需要sudo呢？</p>
<p>因为docker安装的时候是使用的root用户，admin用户是没有权限操作docker的。所以我们这里可以将admin用户加入到docker组（这个组是安装docker的时候自动创建的，这样admin就可以操作docker服务了）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gpasswd -a $&#123;USER&#125; docker</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -a -G docker admin</span><br></pre></td></tr></table></figure>
<p>重启docker</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>
<p>这里有个小问题</p>
<p>查看组，<br><img src="/2017/12/19/docker-swarm/media/bb3cccc8b4e729af591fa0d7cd1916cc.png"></p>
<p>可以看到docker组中有admin这个用户，但是还是无法使用docker命令，从权限可以看出docker组是用读取写入权限的。但是admin还是无法使用docker<br><img src="/2017/12/19/docker-swarm/media/52032f76dc3f8d0dd40f2d624dfdfe73.png"></p>
<p>解决方法就是关闭这个终端，重新连接<br><img src="/2017/12/19/docker-swarm/media/fddf84d3c25c3d2ac18dc4016368f2b5.png"></p>
<h5 id="使用docker-machine-的驱动进行连接并管理其他服务器"><a href="#使用docker-machine-的驱动进行连接并管理其他服务器" class="headerlink" title="使用docker-machine 的驱动进行连接并管理其他服务器"></a>使用docker-machine 的驱动进行连接并管理其他服务器</h5><p>100.70作为docker-machine管理器，并使用admin用户操作。</p>
<p>在admin用户下生成密钥对<br><img src="/2017/12/19/docker-swarm/media/c01e6768e538c2263bfe8ab0a258565c.png"></p>
<p>将生成的公钥放到远程主机的admin（远程主机的admin账户是可以操作docker的）账户去，会提示输入远程主机的admin用户密码<br><img src="/2017/12/19/docker-swarm/media/7f14289ff65ae009238aa4d2b3b416b9.png"></p>
<p>这里出现的问题就是，我们已经关闭了每台主机的密码验证，这种是无法上传的，所以只有分别复制过去<br><img src="/2017/12/19/docker-swarm/media/b28e51e491fdf71f66c33e8b492fbe40.png"></p>
<p>第一个ssh是本地远程的xshell的公钥，第二个是100.70下的admin用户生成的公钥</p>
<p>测试能否远程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 222 admin@192.168.100.71</span><br></pre></td></tr></table></figure>
<p><img src="/2017/12/19/docker-swarm/media/f686a811841ae359acd5f602f833ee12.png"></p>
<p>开始关联</p>
<p>注意，create 命令本是要创建虚拟主机并安装Docker，因为本例中的目标主机已经存在docker。所以已经安装会跳过的。-d 是 –driver的简写形式，主要用来指定使用什么驱动程序来创建目标主机。Docker Machine支持在云服务器上创建主机，就是靠使用不同的驱动来实现了。本例中使用 generic就可以了。接下来以 –generic开头的三个参数主要是指定操作的目标主机和使用的账户。最后一个参数 node1是虚拟机的名称，Docker Machine 会用它来设置目标主机的名称。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-machine create -d generic --generic-ip-address=192.168.100.71 --generic-ssh-port=222 --generic-ssh-user=admin --generic-ssh-key ~/.ssh/id_rsa node1</span><br></pre></td></tr></table></figure>
<p><img src="/2017/12/19/docker-swarm/media/1d974a46bd49d743f09a8616061d3bfe.png"></p>
<p>这里会出错，原因是admin用户无法执行在创建过程中需要执行的命令。所以我们修改，将ssh密钥导入到root用户</p>
<p><img src="/2017/12/19/docker-swarm/media/8872f604b0912d38fe46ae3534000777.png"></p>
<p>删除node1，再次进行创建</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-machine create -d generic --generic-ip-address=192.168.100.71 --generic-ssh-port=222 --generic-ssh-user=root --generic-ssh-key ~/.ssh/id_rsa node1</span><br></pre></td></tr></table></figure>

<p>等待过10分钟，基本就可以了<br><img src="/2017/12/19/docker-swarm/media/b66840b33576ddefbb3cfccaa8dfbd79.png"></p>
<p>将另外的两个节点也加入进来</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in 2 3 ; do docker-machine create -d generic --generic-ip-address=192.168.100.7$i --generic-ssh-port=222 --generic-ssh-user=root --generic-ssh-key ~/.ssh/id_rsa node$i; done</span><br></pre></td></tr></table></figure>
<p><img src="/2017/12/19/docker-swarm/media/389e936bf5bf2de9495c1d08a9da489b.png"></p>
<h4 id="测试效果"><a href="#测试效果" class="headerlink" title="测试效果"></a>测试效果</h4><p>现在测试100.70在不安装docker服务的情况下，使用了docker 节点的变量能否使用docker<br><img src="/2017/12/19/docker-swarm/media/5f407df039a332b7bd8e3f9d3e7c5250.png"></p>
<p>从上面可以看出，并不能，原因是因为没有安装docker客户端。这里我们就不研究如何只安装客户端了，还是安装上docker服务吧，使用admin用户来安装</p>
<p>安装教程<br><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/installation/linux/docker-ce/centos/#install-using-the-repository">https://docs.docker.com/engine/installation/linux/docker-ce/centos/#install-using-the-repository</a></p>
<p>这里当安装好了以后<br><img src="/2017/12/19/docker-swarm/media/ac73e7c39d1f36e9dde595a62f497bca.png"></p>
<p>上面可以看出安装的是docker-ce17.09版本，因为之前的变量导入还在，所以看到客户端版本为17.09，服务端是17.06。<br>移除变量后，再次查看，提示服务端并没运行，这样不就实现了我们的想法，只安装了客户端。<br><img src="/2017/12/19/docker-swarm/media/bc979658500c683434f18603cafbf57a.png"></p>
<p>如果想运行服务，需要加入：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable docker</span><br><span class="line">sudo systemctl start docker</span><br></pre></td></tr></table></figure>
<p>这里我不加入开机启动，和启动服务端。</p>
<h3 id="建立swarm集群"><a href="#建立swarm集群" class="headerlink" title="建立swarm集群"></a>建立swarm集群</h3><p><img src="/2017/12/19/docker-swarm/media/b13d7b05fb2a91b9d98d6b4ddf904f18.png"></p>
<h4 id="将node1作为swarm集群的创建者"><a href="#将node1作为swarm集群的创建者" class="headerlink" title="将node1作为swarm集群的创建者"></a>将node1作为swarm集群的创建者</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm init --advertise-addr $(docker-machine ip node1)</span><br></pre></td></tr></table></figure>

<p><img src="/2017/12/19/docker-swarm/media/00798f4616ec2ba44044b9748766f891.png"></p>
<p>退出node1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval $(docker-machine env -u)</span><br></pre></td></tr></table></figure>

<h4 id="分别将node2和node3，将作为节点服务器加入到集群中"><a href="#分别将node2和node3，将作为节点服务器加入到集群中" class="headerlink" title="分别将node2和node3，将作为节点服务器加入到集群中"></a>分别将node2和node3，将作为节点服务器加入到集群中</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in 2 3; do docker-machine ssh node$i docker swarm join --token SWMTKN-1-2ov80t4wgnrmh4t1d48a0n3uxrrmaojkv9raf1733irvfiw4w2-d0vrx62myyg5wetxkd7r3jl7a $(docker-machine ip node1):2377; done</span><br></pre></td></tr></table></figure>
<p><img src="/2017/12/19/docker-swarm/media/bf82c07ec4f9cc2ee03b1608a0dd05c0.png"></p>
<h4 id="查看集群的节点信息"><a href="#查看集群的节点信息" class="headerlink" title="查看集群的节点信息"></a>查看集群的节点信息</h4><p><img src="/2017/12/19/docker-swarm/media/6619e10f92224cbd772b272113d83dbf.png"></p>
<h4 id="批量修改加速器（这样无法实现），必须要ssh进去后操作后才可以实现"><a href="#批量修改加速器（这样无法实现），必须要ssh进去后操作后才可以实现" class="headerlink" title="批量修改加速器（这样无法实现），必须要ssh进去后操作后才可以实现"></a>批量修改加速器（这样无法实现），必须要ssh进去后操作后才可以实现</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in 1 2 3; do docker-machine ssh node$i curl -sSL https://get.daocloud.io/daotools/set_mirror.sh | sh -s http://ac1e54d0.m.daocloud.io &amp;&amp; sudo systemctl restart docker; done</span><br></pre></td></tr></table></figure>

<h4 id="建立一个nginx测试容器"><a href="#建立一个nginx测试容器" class="headerlink" title="建立一个nginx测试容器"></a>建立一个nginx测试容器</h4><p>这里是三台机器组成集群，副本因子为3，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-machine ssh node1 docker service create -p 80:80 --name swarm-nginx --replicas 3 fsoppelsa/swarm-nginx</span><br></pre></td></tr></table></figure>
<p><img src="/2017/12/19/docker-swarm/media/b12a36820f6209c79b87f728508f6f68.png"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-machine ssh node1 docker service ps swarm-nginx</span><br></pre></td></tr></table></figure>
<p><img src="/2017/12/19/docker-swarm/media/d6602ef5a5cf3b1abde1ac435fada734.png"></p>
<p>从上面可以看出node1作为集群建立者，管理者，也是会作为work节点建立容器的<br>这里我们可以猜想是不是作为节点管理者，在副本因子定义为2的时候，会不会优先选择非管理者建立节点</p>
<p>测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-machine ssh node1 docker service create -p 8080:80 --name swarm-nginx8080 --replicas 2 fsoppelsa/swarm-nginx</span><br></pre></td></tr></table></figure>
<p><img src="/2017/12/19/docker-swarm/media/67d0f5b714ee1908a4d9731871485d59.png"></p>
<p>结果证明：没有定义策略的情况下，还是建立到了管理者node1上面</p>
<p>使用调度策略（约束）来建立一个不在管理者上建立容器的service</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-machine ssh node1 docker service create --constraint &#x27;node.role!=manager&#x27; -p 88:80 --name swarm-nginx88 --replicas 3 fsoppelsa/swarm-nginx</span><br></pre></td></tr></table></figure>
<p><img src="/2017/12/19/docker-swarm/media/bfa6e545402b3fe94ff9db0fba3d07cc.png"></p>
<p><strong>Swarm集群已经建立，清空所有的service。</strong></p>
<h2 id="搭建jenkins服务器（192-168-100-70）"><a href="#搭建jenkins服务器（192-168-100-70）" class="headerlink" title="搭建jenkins服务器（192.168.100.70）"></a>搭建jenkins服务器（192.168.100.70）</h2><h3 id="搭建java和mvn环境"><a href="#搭建java和mvn环境" class="headerlink" title="搭建java和mvn环境"></a>搭建java和mvn环境</h3><p>解压</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf jdk-8u111-linux-x64.tar.gz</span><br><span class="line">sudo mv jdk1.8.0_111/ /usr/local/java</span><br><span class="line">tar zxf apache-maven-3.3.9-bin.tar.gz</span><br><span class="line">sudo mv apache-maven-3.3.9 /usr/local/maven</span><br></pre></td></tr></table></figure>

<p>设置环境变量<br>/etc/profile</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/usr/local/java</span><br><span class="line">export PATH=\$PATH:/usr/local/java/bin</span><br><span class="line">export MAVEN_HOME=/usr/local/maven</span><br><span class="line">export PATH=\$PATH:/usr/local/maven/bin</span><br></pre></td></tr></table></figure>
<p>生效</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br><span class="line">mvn -v</span><br></pre></td></tr></table></figure>
<p><img src="/2017/12/19/docker-swarm/media/eece6544cac4ec77f7b4307c6eb07b8d.png"></p>
<h3 id="安装jenkins服务"><a href="#安装jenkins服务" class="headerlink" title="安装jenkins服务"></a>安装jenkins服务</h3><p>建立一个jenkins目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir Jenkins</span><br><span class="line">mv jenkins.war ./jenkins</span><br></pre></td></tr></table></figure>
<p>安装分屏命令screen</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum -y install screen</span><br></pre></td></tr></table></figure>
<p>建立一个名称为jenkins的screen分屏</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">screen -S jenkins</span><br></pre></td></tr></table></figure>
<p>Ctrl+a+d返回终端</p>
<p>进入jenkins分屏</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">screen -r jenkins</span><br><span class="line">sudo /usr/local/java/bin/java -jar ./jenkins.war --httpPort=404</span><br></pre></td></tr></table></figure>
<p><img src="/2017/12/19/docker-swarm/media/def860b661431e21a4c049be661d9925.png"><br>Ctrl+a+d返回终端<br><img src="/2017/12/19/docker-swarm/media/e012caad6f4e986e620b08290fc16338.png"></p>
<p>Web浏览器打开登录<a target="_blank" rel="noopener" href="http://192.168.100.70:404/">http://192.168.100.70:404</a><br><img src="/2017/12/19/docker-swarm/media/ef842e4773eb0c9bcd20eb61180cf7c0.png"></p>
<p>切换为终端查看，并复制到web页面去<br><img src="/2017/12/19/docker-swarm/media/94d531c8b16d6556d21e4f407a6fb1ec.png"></p>
<p>选择安装<br><img src="/2017/12/19/docker-swarm/media/b702399de69ecbb62a8910bdb60296d2.png"></p>
<p><strong>安装好了后建立一个jenkins账户，密码为jenkins的管理员账户</strong><br><img src="/2017/12/19/docker-swarm/media/c13a15c3ba6c382f5879ab15f4be37fa.png"></p>
<h3 id="修改jenkins的配置"><a href="#修改jenkins的配置" class="headerlink" title="修改jenkins的配置"></a>修改jenkins的配置</h3><p><strong>Maven的配置</strong><br><img src="/2017/12/19/docker-swarm/media/007b745635f9b3b0f33b0a77cb00efcb.png"></p>
<p><strong>使用本地的maven</strong><br><img src="/2017/12/19/docker-swarm/media/e5e28663bc2621463cf50da5109805b5.png"></p>
<p><strong>Java和git使用本地的</strong><br><img src="/2017/12/19/docker-swarm/media/7815874989f7be3c6ccfda91da33da05.png"></p>
<h3 id="新建一个jenkins-swarm项目测试"><a href="#新建一个jenkins-swarm项目测试" class="headerlink" title="新建一个jenkins-swarm项目测试"></a>新建一个jenkins-swarm项目测试</h3><p><img src="/2017/12/19/docker-swarm/media/001903bfe51edd60e98869a90c24d5ea.png"></p>
<p><strong>自定义工作目录</strong><br><img src="/2017/12/19/docker-swarm/media/a00a2e2f41d7ad4f6a40e6ce58ec3bf6.png"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">runuser -l admin -c &#x27;docker-machine ssh node1 docker service create -p 80:80 --name swarm-nginx --replicas 3 fsoppelsa/swarm-nginx&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="/2017/12/19/docker-swarm/media/bf469da815cb0f35252c77692eb736f6.png"></p>
<p><strong>这里因为docker-machine管理是使用的admin用户，而运行jenkins的root用户。所以root用户也无法使用docker-machine管理，这里我们使用runuser这个命令来执行，（是不是起到了安全的作用，我们可以建立一个用户来专门作为管理docker-machine的，）</strong></p>
<p><strong>保存后，点击立即构建</strong><br><img src="/2017/12/19/docker-swarm/media/d88cda87517d1303f4e8d1977e456ea7.png"></p>
<p><strong>登录docker-machine的机器验证</strong><br><img src="/2017/12/19/docker-swarm/media/52408e5603f2cd706dd99e4886662142.png"></p>
<p><strong>访问验证</strong><br><img src="/2017/12/19/docker-swarm/media/8693b63e5cedd93086a0cdc91b72ea8a.png"><br><img src="/2017/12/19/docker-swarm/media/345ad087a16c1e6614eabac8e37fac51.png"><br><img src="/2017/12/19/docker-swarm/media/6c33911618787cca90f6d4ae6be1901a.png"></p>
<p><strong>这里有一个猜想：</strong><br><strong>这里的docker-machine因为是使用的admin用户，所以docker-machine管理的主机的配置文件都放在/home/admin/.docker下，权限为700，这里我将权限设置为770后，并将root组设置为宿组，还是无法使用docker-machine，最后提示权限太高，导致无法运行。修改为700后即可。</strong><br><img src="/2017/12/19/docker-swarm/media/321f0f30dc407288b219a68613e838e9.png"></p>
<h3 id="构建一个maven项目"><a href="#构建一个maven项目" class="headerlink" title="构建一个maven项目"></a>构建一个maven项目</h3><p><strong>安装jenkins插件，</strong><br><img src="/2017/12/19/docker-swarm/media/2f323f77530f4a84fa6c8535f0f9971c.png"></p>
<p><strong>建立一个名为test-oss的maven项目</strong><br><img src="/2017/12/19/docker-swarm/media/77fd0ea2187e8d461459f080a04bb455.png"></p>
<p><strong>Git代码来源自己去配置配置好。存储位置：/tmp/jenkins-buildenv/${JOB_NAME}/workspace</strong><br><strong>build配置，指定pom.xml位置，第一次操作使用mvn install ，后续都使用mvn clean package -Dmaven.test.skip=true</strong><br><img src="/2017/12/19/docker-swarm/media/1a78b18457d64537808f7f88b5d0edfd.png"></p>
<p><strong>Build操作使用shell脚本完成</strong></p>
<p><strong>因为运行jenkins的账户是root，所以使用runuser命令来操作，首先将jenkins的build后的代码复制到docker swarm的manager上，然后再由manager创建集群时候指定挂载</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">BUILD_ID=DONTKILLME</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">项目定义变量</span></span><br><span class="line">IMAGE=huisebug/jetty:1</span><br><span class="line">WARPAG=17find-op.war</span><br><span class="line">PORT=8100</span><br><span class="line">PROJECTPATH=17find/17find-op</span><br><span class="line">WEBAPPS=/home/admin/$&#123;JOB_NAME&#125;/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">启动</span></span><br><span class="line"><span class="meta">#</span><span class="bash">runuser -l admin -c <span class="string">&quot;mkdir <span class="variable">$WEBAPPS</span>&quot;</span></span></span><br><span class="line">runuser -l admin -c &quot;cd $WEBAPPS &amp;&amp; rm -rf * &amp;&amp; /usr/local/java/bin/jar xf $WORKSPACE/$PROJECTPATH/target/$WARPAG&quot;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">runuser -l admin -c <span class="string">&quot;docker-machine ssh node1 mkdir /root/swarmsource/&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">runuser -l admin -c <span class="string">&quot;docker-machine ssh node1 rm -rf /root/swarmsource/<span class="variable">$&#123;JOB_NAME&#125;</span>/&quot;</span></span></span><br><span class="line">runuser -l admin -c &quot;docker-machine scp -r $WEBAPPS node1:/root/swarmsource/ &quot;</span><br><span class="line">runuser -l admin -c &quot; \</span><br><span class="line">docker-machine ssh node1 docker service create \</span><br><span class="line">--mount &#x27;type=bind,src=/root/swarmsource/$&#123;JOB_NAME&#125;/,dst=/usr/local/jetty/webapps/ROOT/&#x27; \</span><br><span class="line">--name $&#123;JOB_NAME&#125; -p $PORT:8080 \</span><br><span class="line">--constraint &#x27;node.role!=manager&#x27; \</span><br><span class="line">--replicas 2 $IMAGE \</span><br><span class="line">&quot;</span><br></pre></td></tr></table></figure>
<p><strong>查看效果，稍微等下</strong><br><img src="/2017/12/19/docker-swarm/media/2dc47afee3026be1c4bce685952c2041.png"></p>
<h1 id="做到这里的时候总结出一些更好的想法："><a href="#做到这里的时候总结出一些更好的想法：" class="headerlink" title="做到这里的时候总结出一些更好的想法："></a>做到这里的时候总结出一些更好的想法：</h1><ol>
<li><strong>因为jenkins如果是使用的war的形式运行的，那么他会需要创建文件夹和配置文件，这样就需要管理权限，这样将会使用到root的权限，这样是有点不安全的，所以如果在真实环境中，推荐jenkins还是使用docker容器这样的方式来运行。</strong></li>
<li><strong>还有一种解决方式就是node1作为集群的manager，我们可以使用约束来不让他参与dockerservice的创建work节点容器，只作为jenkins这类的代码拉取工作。就可以省去我们这里的操作，需要在docker-machine控制台将文件夹复制到node1里面去，再运行dockerservice create的创建。</strong></li>
<li><strong>docker swarm mode是使用service的方式建立集群并负载均衡。这样可以将项目整合在一起加强做集群</strong></li>
<li><strong>这里我的操作都没用到docker-machine env的操作，因为为了使用shell，只得使用ssh 节点 命令的方式来进行操作。</strong></li>
<li><strong>Nginx服务器和nginx代理其实可以整合，但是我们为了优化配置，代理分开</strong></li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">huisebug</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://huisebug.github.io/2017/12/19/docker-swarm/">https://huisebug.github.io/2017/12/19/docker-swarm/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://huisebug.github.io" target="_blank">huisebug</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/docker/">docker</a><a class="post-meta__tags" href="/tags/jenkins/">jenkins</a><a class="post-meta__tags" href="/tags/expect%E8%84%9A%E6%9C%AC/">expect脚本</a><a class="post-meta__tags" href="/tags/docker-machine/">docker machine</a><a class="post-meta__tags" href="/tags/docker-swarm/">docker swarm</a></div><div class="post_share"><div class="social-share" data-image="/img/docker.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2018/09/06/k8s%E5%B8%B8%E8%A7%81%E6%96%B9%E6%B3%95%E5%8F%8A%E9%94%99%E8%AF%AF%E8%A7%A3%E5%86%B3/"><img class="prev-cover" src="/img/head.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">持续更新-20190306-k8s常见方法及错误解决</div></div></a></div><div class="next-post pull-right"><a href="/2017/12/19/docker%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/"><img class="next-cover" src="/img/docker.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Docker基础概念</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2017/12/19/docker基础概念/" title="Docker基础概念"><img class="cover" src="/img/docker.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-12-19</div><div class="title">Docker基础概念</div></div></a></div><div><a href="/2018/09/06/k8s常见方法及错误解决/" title="持续更新-20190306-k8s常见方法及错误解决"><img class="cover" src="/img/head.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-09-06</div><div class="title">持续更新-20190306-k8s常见方法及错误解决</div></div></a></div><div><a href="/2021/07/06/kata容器的一些分享/" title="kata容器的一些分享"><img class="cover" src="/img/kata.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-06</div><div class="title">kata容器的一些分享</div></div></a></div><div><a href="/2019/05/24/mysql-mycat/" title="mysql5.7主从复制及mycat1.6读写分离"><img class="cover" src="/img/mysql.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-05-24</div><div class="title">mysql5.7主从复制及mycat1.6读写分离</div></div></a></div><div><a href="/2020/06/03/jenkins-CICD-k8s/" title="Jenkins持续集成到Kubernetes集群"><img class="cover" src="/img/jenkins+k8s.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-06-03</div><div class="title">Jenkins持续集成到Kubernetes集群</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/linuxqie.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">huisebug</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">67</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/huisebug"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/huisebug" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:huisebug@aliyun.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">贯彻容器搬砖化 提供有偿技术支援 请联系QQ-1139873783</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Docker-machine-Docker-swarm-Nginx-Nginx%E4%BB%A3%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">Docker-machine+Docker swarm+Nginx+Nginx代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%8E%AF%E5%A2%83%EF%BC%9A"><span class="toc-number">1.1.</span> <span class="toc-text">准备环境：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%89%A7%E8%A1%8C%E4%B9%8B%E5%89%8D%E9%9C%80%E8%A6%81%E5%AE%9E%E7%8E%B0%E7%9A%84%E8%A6%81%E6%B1%82"><span class="toc-number">1.2.</span> <span class="toc-text">项目执行之前需要实现的要求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E4%B8%8D%E4%BD%BF%E7%94%A8root%EF%BC%8C%E4%BD%BF%E7%94%A8%E6%96%B0%E7%94%A8%E6%88%B7admin%E6%93%8D%E4%BD%9C"><span class="toc-number">1.3.</span> <span class="toc-text">修改不使用root，使用新用户admin操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E8%BD%AF%E4%BB%B6%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.3.1.</span> <span class="toc-text">远程软件连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0expect%E8%84%9A%E6%9C%AC"><span class="toc-number">1.3.2.</span> <span class="toc-text">上传expect脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B%EF%BC%9A"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">简介：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9%EF%BC%9A"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">文件内容：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#expect%E8%84%9A%E6%9C%AC%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B9"><span class="toc-number">1.3.3.</span> <span class="toc-text">expect脚本的配置文件修改</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E5%85%B6%E4%BB%965%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E4%BF%A1%E6%81%AF%E5%86%99%E5%88%B0passwd%E6%96%87%E4%BB%B6%E4%B8%AD"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">将其他5台服务器的信息写到passwd文件中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85expect%E8%84%9A%E6%9C%AC%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">安装expect脚本执行命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E5%90%84%E8%84%9A%E6%9C%AC%E6%98%AF%E5%90%A6%E6%9C%89%E9%94%99%E8%AF%AF%E7%9A%84%E5%9C%B0%E6%96%B9"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">检查各脚本是否有错误的地方</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%88%AB%E7%99%BB%E5%BD%95admin%E8%B4%A6%E6%88%B7"><span class="toc-number">1.3.4.</span> <span class="toc-text">分别登录admin账户</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85docker%E7%9A%84%E7%AD%89%E4%B8%80%E7%B3%BB%E5%88%97%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.</span> <span class="toc-text">安装docker的等一系列服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E9%A1%B9%E7%9B%AE%E6%B5%8B%E8%AF%95%EF%BC%9A"><span class="toc-number">1.4.1.</span> <span class="toc-text">新增项目测试：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%99%E9%87%8C%E7%9A%84100-70%E6%9C%BA%E5%99%A8%E6%98%AF%E5%85%A8%E6%96%B0%E7%9A%84%E4%B8%80%E5%8F%B0%E6%9C%BA%E5%99%A8%EF%BC%8C%E5%BD%93%E6%88%91%E4%BB%AC%E5%8F%AA%E5%AE%89%E8%A3%85docker-machine%E7%9A%84%E6%97%B6%E5%80%99%E7%9C%8B%E6%98%AF%E5%90%A6%E4%B8%80%E5%AE%9A%E9%9C%80%E8%A6%81docker%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">这里的100.70机器是全新的一台机器，当我们只安装docker-machine的时候看是否一定需要docker服务</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E4%B8%89%E5%8F%B0%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%83%85%E5%86%B5%EF%BC%9A"><span class="toc-number">1.4.1.1.1.</span> <span class="toc-text">查看三台节点服务器情况：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8docker-machine-%E7%9A%84%E9%A9%B1%E5%8A%A8%E8%BF%9B%E8%A1%8C%E8%BF%9E%E6%8E%A5%E5%B9%B6%E7%AE%A1%E7%90%86%E5%85%B6%E4%BB%96%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">1.4.1.1.2.</span> <span class="toc-text">使用docker-machine 的驱动进行连接并管理其他服务器</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%95%88%E6%9E%9C"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">测试效果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8Bswarm%E9%9B%86%E7%BE%A4"><span class="toc-number">1.4.2.</span> <span class="toc-text">建立swarm集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86node1%E4%BD%9C%E4%B8%BAswarm%E9%9B%86%E7%BE%A4%E7%9A%84%E5%88%9B%E5%BB%BA%E8%80%85"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">将node1作为swarm集群的创建者</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%88%AB%E5%B0%86node2%E5%92%8Cnode3%EF%BC%8C%E5%B0%86%E4%BD%9C%E4%B8%BA%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8A%A0%E5%85%A5%E5%88%B0%E9%9B%86%E7%BE%A4%E4%B8%AD"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">分别将node2和node3，将作为节点服务器加入到集群中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%9A%84%E8%8A%82%E7%82%B9%E4%BF%A1%E6%81%AF"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">查看集群的节点信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9%E5%8A%A0%E9%80%9F%E5%99%A8%EF%BC%88%E8%BF%99%E6%A0%B7%E6%97%A0%E6%B3%95%E5%AE%9E%E7%8E%B0%EF%BC%89%EF%BC%8C%E5%BF%85%E9%A1%BB%E8%A6%81ssh%E8%BF%9B%E5%8E%BB%E5%90%8E%E6%93%8D%E4%BD%9C%E5%90%8E%E6%89%8D%E5%8F%AF%E4%BB%A5%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.2.4.</span> <span class="toc-text">批量修改加速器（这样无法实现），必须要ssh进去后操作后才可以实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E4%B8%80%E4%B8%AAnginx%E6%B5%8B%E8%AF%95%E5%AE%B9%E5%99%A8"><span class="toc-number">1.4.2.5.</span> <span class="toc-text">建立一个nginx测试容器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAjenkins%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88192-168-100-70%EF%BC%89"><span class="toc-number">1.5.</span> <span class="toc-text">搭建jenkins服务器（192.168.100.70）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAjava%E5%92%8Cmvn%E7%8E%AF%E5%A2%83"><span class="toc-number">1.5.1.</span> <span class="toc-text">搭建java和mvn环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85jenkins%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.5.2.</span> <span class="toc-text">安装jenkins服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9jenkins%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.3.</span> <span class="toc-text">修改jenkins的配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E4%B8%80%E4%B8%AAjenkins-swarm%E9%A1%B9%E7%9B%AE%E6%B5%8B%E8%AF%95"><span class="toc-number">1.5.4.</span> <span class="toc-text">新建一个jenkins-swarm项目测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AAmaven%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.5.5.</span> <span class="toc-text">构建一个maven项目</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%81%9A%E5%88%B0%E8%BF%99%E9%87%8C%E7%9A%84%E6%97%B6%E5%80%99%E6%80%BB%E7%BB%93%E5%87%BA%E4%B8%80%E4%BA%9B%E6%9B%B4%E5%A5%BD%E7%9A%84%E6%83%B3%E6%B3%95%EF%BC%9A"><span class="toc-number">2.</span> <span class="toc-text">做到这里的时候总结出一些更好的想法：</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/06/06/minio-to-azure_blob/" title="minio数据迁移到azure blob"><img src="/img/tototo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="minio数据迁移到azure blob"/></a><div class="content"><a class="title" href="/2024/06/06/minio-to-azure_blob/" title="minio数据迁移到azure blob">minio数据迁移到azure blob</a><time datetime="2024-06-06T03:04:01.000Z" title="发表于 2024-06-06 11:04:01">2024-06-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/21/vector+clickhouse/" title="vector+clickhouse:新型kubernetes集群日志收集方案"><img src="/img/vector+clickhouse.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="vector+clickhouse:新型kubernetes集群日志收集方案"/></a><div class="content"><a class="title" href="/2024/05/21/vector+clickhouse/" title="vector+clickhouse:新型kubernetes集群日志收集方案">vector+clickhouse:新型kubernetes集群日志收集方案</a><time datetime="2024-05-21T09:04:01.000Z" title="发表于 2024-05-21 17:04:01">2024-05-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/02/04/terraform-kubernetes/" title="terraform部署kubernetes1.26.12集群"><img src="/img/terraform-kubernetes.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="terraform部署kubernetes1.26.12集群"/></a><div class="content"><a class="title" href="/2024/02/04/terraform-kubernetes/" title="terraform部署kubernetes1.26.12集群">terraform部署kubernetes1.26.12集群</a><time datetime="2024-02-04T08:04:01.000Z" title="发表于 2024-02-04 16:04:01">2024-02-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/02/04/terraform-k8s-golangstruct/" title="golang terraform kubernetes结构体"><img src="/img/terraform-kubernetes.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="golang terraform kubernetes结构体"/></a><div class="content"><a class="title" href="/2024/02/04/terraform-k8s-golangstruct/" title="golang terraform kubernetes结构体">golang terraform kubernetes结构体</a><time datetime="2024-02-04T03:04:01.000Z" title="发表于 2024-02-04 11:04:01">2024-02-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/03/kubernetesalias/" title="kubernetesalias:kubernetes封装命令工具"><img src="/img/kubernetesalias.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="kubernetesalias:kubernetes封装命令工具"/></a><div class="content"><a class="title" href="/2023/08/03/kubernetesalias/" title="kubernetesalias:kubernetes封装命令工具">kubernetesalias:kubernetes封装命令工具</a><time datetime="2023-08-03T08:04:01.000Z" title="发表于 2023-08-03 16:04:01">2023-08-03</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/docker.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2024 By huisebug</div><div class="footer_custom_text">Good Luck</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>